
<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESSPROOF | The Essence of Registry</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;800&family=Cinzel+Decorative:wght@700;900&family=Inter:wght@300;400;600&family=Playfair+Display:ital,wght@1,400&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root { --bg: #000000; --panel: rgba(13, 18, 35, 0.95); --glass-border: rgba(255, 255, 255, 0.08); --gold: #d4af37; --gold-light: #f7ef8a; --gold-dark: #855a16; --ink: #e2e8f0; }
        #modal-dashboard { z-index: 8000 !important; } #modal-repo-detail { z-index: 9000 !important; } #modal-payment { z-index: 9500 !important; } #modal-judiciary-auth, #modal-judiciary-view { z-index: 11000 !important; } #modal-video { z-index: 12000 !important; } #modal-repo-login { z-index: 13000 !important; } 
        .info-modal { z-index: 10000 !important; }
        #side-menu { z-index: 20000 !important; }
        
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--ink); min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden; }
        h1, h2, h3, .brand-font { font-family: 'Cinzel', serif; } .logo-font { font-family: 'Cinzel Decorative', serif; } .legal-font { font-family: 'Times New Roman', Times, serif; } .mono-font { font-family: 'JetBrains Mono', monospace; }
        .glass-panel { background: var(--panel); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8); }
        .gold-btn { background: linear-gradient(135deg, var(--gold-dark) 0%, var(--gold) 50%, var(--gold-dark) 100%); color: #fefce8; border: 1px solid #713f12; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; cursor: pointer; position: relative; z-index: 50; }
        .gold-btn:active { transform: scale(0.96); } .gold-btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); background: #333; transform: none; }
        .input-field { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); color: white; transition: all 0.3s; }
        .input-field:focus { border-color: var(--gold); outline: none; box-shadow: 0 0 0 2px rgba(212,175,55,0.15); }
        .fade-in { animation: fadeIn 0.5s ease-out; } @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
        .split-container { display: flex; width: 100%; height: 85vh; position: relative; overflow: hidden; }
        .split-side { flex: 1; position: relative; transition: all 0.6s cubic-bezier(0.25, 0.8, 0.25, 1); display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 2rem; cursor: pointer; overflow: hidden; background: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%); color: #fff; }
        .split-side::before { content: ''; position: absolute; inset: 0; background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d4af37' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); opacity: 0.5; }
        .split-side:hover { flex: 1.3; }
        .split-side h2 { color: transparent; background: linear-gradient(to bottom, #f7ef8a, #d4af37); -webkit-background-clip: text; background-clip: text; text-shadow: 0 0 20px rgba(212,175,55,0.3); }
        .feature-list { list-style: none; padding: 0; margin-top: 20px; text-align: left; width: 80%; max-width: 300px; }
        .feature-list li { padding: 12px 0; display: flex; align-items: center; gap: 10px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #d4af37; opacity: 0.8; border-bottom: 1px solid rgba(212,175,55,0.1); }
        .btn-action { background: linear-gradient(135deg, var(--gold-dark) 0%, var(--gold) 50%, var(--gold-dark) 100%); border: 1px solid #fff; color: #000; padding: 15px 40px; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; margin-top: 30px; box-shadow: 0 0 20px rgba(212,175,55,0.4); transition: all 0.3s; }
        .btn-action:hover { transform: scale(1.05); box-shadow: 0 0 40px rgba(212,175,55,0.6); }
        .side-express { border-right: 1px solid rgba(212, 175, 55, 0.2); } .side-premium { border-left: 1px solid rgba(212, 175, 55, 0.2); }
        .room-join-bar { position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.95); backdrop-filter: blur(10px); border: 1px solid var(--gold); padding: 9px 15px; border-radius: 50px; display: flex; gap: 8px; align-items: center; z-index: 100; box-shadow: 0 5px 20px rgba(0,0,0,0.6); width: auto; max-width: 270px; }
        .room-join-bar input { font-size: 15px; } 
        @media (max-width: 768px) { .split-container { flex-direction: column; height: auto; } .split-side { padding: 3rem 1rem; min-height: 50vh; } .side-express:hover, .side-premium:hover { flex: 1; } .room-join-bar { bottom: 10px; width: 90%; max-width: 90%; } }
        .scan-line { width: 100%; height: 2px; background: #d4af37; box-shadow: 0 0 10px #d4af37; animation: scan 1.5s infinite linear; } @keyframes scan { 0% {transform: translateY(-50px); opacity:0;} 50% {opacity:1;} 100% {transform: translateY(50px); opacity:0;} }
        .template-form-group { margin-bottom: 10px; } .template-label { font-size: 10px; text-transform: uppercase; color: #94a3b8; display: block; margin-bottom: 4px; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #0b1021; } ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: var(--gold); }
        .legal-checkbox { accent-color: var(--gold); width: 16px; height: 16px; margin-top: 3px; cursor: pointer; }
        #toast-msg { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(13, 18, 35, 0.95); border: 1px solid #d4af37; color: #d4af37; padding: 12px 24px; border-radius: 8px; font-size: 12px; font-weight: bold; box-shadow: 0 10px 30px rgba(0,0,0,0.8); z-index: 10000; display: none; align-items: center; gap: 10px; }
        .participant-card { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 10px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; transition: all 0.3s; }
        .participant-card.active-user { border-color: var(--gold); background: rgba(212, 175, 55, 0.05); box-shadow: inset 0 0 10px rgba(212, 175, 55, 0.1); }
        .icon-box { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; margin-left: 6px; transition: all 0.3s; }
        .status-gray { color: #475569; background: #1e293b; border: 1px solid #334155; } .status-gold { color: #fefce8; background: var(--gold); border: 1px solid #fefce8; box-shadow: 0 0 8px rgba(212,175,55,0.4); cursor: pointer; } .status-gold:hover { transform: scale(1.1); }
        .selected-row { background: rgba(212, 175, 55, 0.15) !important; border-left: 4px solid var(--gold); }
        
        .paper-view { font-family: 'Times New Roman', serif; color: black; background: #fff; padding: 40px; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.5); min-height: 800px; box-sizing: border-box; max-width: 100%; }
        .paper-watermark { position: absolute; top: 40%; left: 30%; transform: rotate(-45deg); font-size: 80px; color: rgba(0,0,0,0.05); font-family: 'Cinzel', serif; z-index: 0; pointer-events: none; }
        .paper-header { text-align: center; border-bottom: 2px solid #d4af37; padding-bottom: 20px; margin-bottom: 30px; position: relative; z-index: 1; }
        .paper-header h1 { font-family: 'Cinzel', serif; font-size: 16px; margin: 0; color: black; }
        .paper-title { font-size: 18px; text-transform: uppercase; text-align: center; border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 20px; font-weight: bold; }
        
        .paper-body { 
            white-space: pre-wrap; 
            word-wrap: break-word;      
            overflow-wrap: break-word;  
            line-height: 1.6; 
            text-align: justify; 
            font-size: 14px; 
            position: relative; 
            z-index: 1; 
            width: 100%;
        }
        
        .paper-sigs { margin-top: 50px; display: flex; gap: 30px; flex-wrap: wrap; position: relative; z-index: 1; }
        .paper-sig-block { border-top: 1px solid #000; padding-top: 5px; width: 200px; font-size: 11px; }
        .paper-hash-box { background-color: #fffbeb; border: 2px solid #d4af37; padding: 10px; margin-top: 40px; text-align: center; font-family: monospace; font-size: 10px; color: #855a16; position: relative; z-index: 1; }
        .encrypted-view { font-family: monospace; word-break: break-all; color: #34d399; font-size: 11px; background: black; padding: 20px; border: 1px solid #333; max-height: 600px; overflow-y: auto; }
        
        .smart-var {
            background-color: rgba(212, 175, 55, 0.15);
            border-bottom: 1px dashed #d4af37;
            padding: 0 2px;
            border-radius: 2px;
            color: #fff;
            transition: all 0.2s;
        }
        .smart-var:hover {
            background-color: rgba(212, 175, 55, 0.3);
            cursor: text;
        }
        
        #create-text {
            outline: none;
            white-space: pre-wrap;      
            word-wrap: break-word;      
            overflow-wrap: break-word;  
            overflow-y: auto;
            max-width: 100%;            
        }
        #create-text:focus {
            box-shadow: 0 0 0 2px rgba(212,175,55,0.15);
            border-color: var(--gold);
        }
    </style>
</head>
<body>

    <div id="toast-msg" class="fade-in">
        <i class="fas fa-check-circle text-[#d4af37] text-lg"></i>
        <span id="toast-text">REQUEST REGISTERED.</span>
    </div>

    <header class="border-b border-white/10 bg-[#000000]/90 sticky top-0 z-50 backdrop-blur-md">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-6">
                <div class="flex items-center gap-3 cursor-pointer" onclick="location.reload()">
                    <div>
                        <h1 class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-b from-[#f7ef8a] to-[#d4af37] tracking-[0.1em] logo-font" style="filter: drop-shadow(0px 2px 0px rgba(0,0,0,0.8));">ESSPROOF</h1>
                        <p class="text-[9px] text-gray-400 uppercase tracking-[0.3em] font-bold"> The Essence of Registry | Private Non-Governmental Platform  Secure Individual & Multi-Party Document Sealing </p>
                    </div>
                </div>
                <button onclick="openJudiciaryLogin()" class="hidden md:flex items-center gap-2 text-[12px] bg-[#d4af37]/10 text-[#d4af37] border border-[#d4af37]/30 px-3 py-1.5 rounded hover:bg-[#d4af37]/20 hover:text-white transition relative right-6">
                    <i class="fas fa-scale-balanced"></i> Authorized Access
                </button>
            </div>

            <div class="flex items-center gap-6">
                <div class="hidden md:flex flex-col items-end border-r border-white/10 pr-6">
                    <span class="text-[9px] text-gray-500 uppercase tracking-widest">Chief Legal Architect</span>
                    <span class="text-[#d4af37] font-serif text-[11px] italic ">M.A.SHAKIBANIA</span>
                </div>
                <button onclick="openDashboard()" class="flex items-center gap-2 text-xs text-gray-400 hover:text-white transition">
                    <div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center border border-white/20"><i class="fas fa-folder-open"></i></div>
                    <span class="hidden sm:inline">Repository</span>
                </button>
                <button onclick="toggleMenu()" class="ml-2 text-[#d4af37] hover:text-white transition text-xl px-2">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
    </header>

    <div id="side-menu" class="fixed inset-y-0 right-0 w-72 bg-[#0d1223] border-l border-[#d4af37]/30 transform translate-x-full transition duration-300 ease-in-out flex flex-col shadow-2xl p-6">
        <div class="flex justify-between items-center mb-8 border-b border-white/10 pb-4">
            <span class="text-[#d4af37] font-bold uppercase tracking-widest text-sm">Menu</span>
            <button onclick="toggleMenu()" class="text-gray-400 hover:text-white"><i class="fas fa-times text-lg"></i></button>
        </div>
        <nav class="flex flex-col gap-4">
            <!-- NEW: About Us Button -->
            <button onclick="openInfoModal('about')" class="text-left text-gray-300 hover:text-[#d4af37] text-sm uppercase font-bold tracking-wider py-2 border-b border-white/5"><i class="fas fa-users w-6"></i> About Us</button>
            
            <button onclick="openInfoModal('legal')" class="text-left text-gray-300 hover:text-[#d4af37] text-sm uppercase font-bold tracking-wider py-2 border-b border-white/5"><i class="fas fa-scale-balanced w-6"></i> Terms & Legal</button>
            <button onclick="openInfoModal('pricing')" class="text-left text-gray-300 hover:text-[#d4af37] text-sm uppercase font-bold tracking-wider py-2 border-b border-white/5"><i class="fas fa-tags w-6"></i> Pricing Formula</button>
            <button onclick="openInfoModal('faq')" class="text-left text-gray-300 hover:text-[#d4af37] text-sm uppercase font-bold tracking-wider py-2 border-b border-white/5"><i class="fas fa-question-circle w-6"></i> FAQ</button>
            <button onclick="openInfoModal('contact')" class="text-left text-gray-300 hover:text-[#d4af37] text-sm uppercase font-bold tracking-wider py-2 border-b border-white/5"><i class="fas fa-envelope w-6"></i> Contact Support</button>
            <button onclick="openInfoModal('video')" class="text-left text-gray-300 hover:text-[#d4af37] text-sm uppercase font-bold tracking-wider py-2 border-b border-white/5"><i class="fas fa-play-circle w-6"></i> Video Guide</button>
            <!-- NEW: User Guide Button -->
            <button onclick="openInfoModal('guide')" class="text-left text-gray-300 hover:text-[#d4af37] text-sm uppercase font-bold tracking-wider py-2 border-b border-white/5"><i class="fas fa-book-open w-6"></i> User Guide</button>
        </nav>
        <div class="mt-auto text-[9px] text-gray-600 text-center">
            Essproof Systems v2.1<br>Secure. Private. Boundless.
        </div>
    </div>

    <!-- NEW: About Us Modal -->
    <div id="modal-about" class="fixed inset-0 bg-black/95 info-modal hidden items-center justify-center p-4">
        <div class="w-full max-w-2xl bg-[#0f172a] p-8 rounded-xl border border-[#d4af37]/30 shadow-2xl relative max-h-[90vh] overflow-y-auto">
            <button onclick="closeInfoModal('about')" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
            <h3 class="text-xl text-[#d4af37] brand-font mb-6 border-b border-white/10 pb-2">Architectural Pedigree & Vision</h3>
            <div class="text-xs text-gray-300 space-y-4 leading-relaxed font-serif text-justify">
                <p>
                    <strong class="text-white block mb-1 text-sm">The Essence of Registry</strong>
                    Essproof is not merely a technological platform; it is the crystallization of nearly three decades of high-level legal and forensic expertise. Our mission is to bridge the gap between traditional legal intent and modern digital immutability.
                </p>
                <p>
                    <strong class="text-white block mb-1 text-sm">Expertise & Heritage</strong>
                    The architectural foundation of Essproof is supported by a synergetic collaboration of international experts. Our core design is led by a team with over <strong>28 years of senior legal experience</strong>, ensuring that every digital process mirrors the rigor of physical legal standards.
                </p>
                <p>
                    <strong class="text-white block mb-1 text-sm">Multidisciplinary Advisory Board</strong>
                    Our infrastructure is fortified by senior advisors in:
                    <ul class="list-disc pl-5 mt-2 space-y-1 text-gray-400">
                        <li><strong>Strategic Management:</strong> Ensuring robust operational continuity.</li>
                        <li><strong>Computer Science & AI:</strong> Implementing state-of-the-art encryption and biometric analysis.</li>
                        <li><strong>EU Regulatory Law:</strong> Aligning with global data privacy standards.</li>
                        <li><strong>International Law (Solicitor, Australia):</strong> Providing a global perspective on document validity.</li>
                    </ul>
                </p>
                <p class="italic text-gray-500 border-l-2 border-[#d4af37] pl-3 mt-4">
                    "We do not replace the law; we provide the ultimate evidentiary vessel for it."
                </p>
            </div>
        </div>
    </div>

    <!-- UPDATED: Legal Modal (Stronger Terms) -->
    <div id="modal-legal" class="fixed inset-0 bg-black/95 info-modal hidden items-center justify-center p-4">
        <div class="w-full max-w-2xl bg-[#0f172a] p-8 rounded-xl border border-[#d4af37]/30 shadow-2xl relative max-h-[90vh] overflow-y-auto">
            <button onclick="closeInfoModal('legal')" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
            <h3 class="text-xl text-[#d4af37] brand-font mb-6 border-b border-white/10 pb-2">Terms of Service & Legal Disclaimer</h3>
            <div class="text-xs text-gray-300 space-y-4 leading-relaxed font-serif text-justify">
                
                <div class="bg-red-900/20 border border-red-500/30 p-3 rounded mb-4">
                    <strong class="text-red-400 block mb-1">CRITICAL NOTICE: NON-INSTITUTIONAL NATURE</strong>
                    Essproof operates exclusively as a <strong>Private, Independent, and Technical Facilitator</strong>. We explicitly declare that we are NOT a law firm, notary public, court of law, arbitration center, or government entity. We provide a secure, transparent tool for parties to generate "Self-Willed Instruments" based on their own mutual consent.
                </div>

                <p><strong class="text-white block mb-1">1. The "Blind Facilitator" Policy</strong> 
                We operate as a "Blind Technical Facilitator." This means we do not verify the real-world identities, social relationships, financial solvency, or underlying intent of the users beyond the digital metrics provided. The Initiator is solely responsible for entering correct names/IDs. Essproof bears no liability for fraud, mistaken identity, or disputes arising from private interactions.</p>

                <p><strong class="text-white block mb-1">2. Forensic Data Collection & Consent</strong> 
                By using this platform, you explicitly consent to the collection and permanent embedding of forensic metadata, including but not limited to: <strong>Real-time IP Address, Precise GPS Geolocation, and Biometric Video/Audio</strong>. This data is collected solely for the purpose of "Non-Repudiation" (preventing denial of signature) and establishing a chain of custody. You waive any right to claim privacy violation regarding this specific evidentiary data in legal proceedings.</p>

                <p><strong class="text-white block mb-1">3. User Warranties & Prohibited Use</strong> 
                You warrant that you are of legal age and sound mind. You strictly agree NOT to use Essproof for: (a) Illegal transactions, (b) Money laundering, (c) Coerced agreements, or (d) Documents violating public order. Any document found to be generated for illicit purposes renders the platform's protection void ab initio.</p>

                <p><strong class="text-white block mb-1">4. Limitation of Liability</strong> 
                Essproof assumes responsibility solely for proven technical failures directly attributable to the Platform's infrastructure (e.g., server crash). In such specific events, our liability is strictly limited to the <strong>refund of the service fee paid</strong>. The Platform bears no further liability for consequential damages, lost profits, or legal outcomes of the instruments generated.</p>

                <p><strong class="text-white block mb-1">5. No Attorney-Client Relationship</strong> 
                The disclosure of our team's professional background (Legal, AI, Management) is intended solely to demonstrate the rigorous technical standards of the platform. It is NOT an advertisement of legal services, nor does it establish a client-attorney relationship. Consult a local attorney for legal advice.</p>
            </div>
        </div>
    </div>
    <div id="modal-pricing" class="fixed inset-0 bg-black/95 info-modal hidden items-center justify-center p-4">
        <div class="w-full max-w-lg bg-[#0f172a] p-8 rounded-xl border border-[#d4af37]/30 shadow-2xl relative">
            <button onclick="closeInfoModal('pricing')" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
            <h3 class="text-xl text-[#d4af37] brand-font mb-6 text-center">Pricing Transparency Policy</h3>
            <div class="space-y-4 text-xs text-gray-300">
                <div class="flex justify-between border-b border-white/10 pb-2">
                    <span>Non-Financial Documents</span>
                    <span class="text-white font-bold">$24.00 Fixed</span>
                </div>
                <div class="space-y-2">
                    <p class="text-[#d4af37] font-bold uppercase tracking-widest text-[10px]">Financial Documents</p>
                    <div class="flex justify-between"><span>$0 - $1,000</span><span class="text-white">$25.00 Fixed</span></div>
                    <div class="flex justify-between"><span>$1,001 - $10,000</span><span class="text-white">Base $25 + $2 / $1k</span></div>
                    <div class="flex justify-between"><span>$10,001 - $100,000</span><span class="text-white">Base $43 + $5 / $5k</span></div>
                    <div class="flex justify-between"><span>$100,001 - $500,000</span><span class="text-white">0.12%</span></div>
                    <div class="flex justify-between"><span>$500,001 - $1,000,000</span><span class="text-white">0.10%</span></div>
                    <div class="flex justify-between"><span>$1,000,001 - $10,000,000</span><span class="text-white">0.08%</span></div>
                    <div class="flex justify-between"><span>Above $10,000,000</span><span class="text-white">0.06%</span></div>
                </div>
                <div class="bg-blue-900/20 p-3 rounded border border-blue-500/30 mt-4">
                    <p class="text-blue-200 font-bold mb-1">Discounts</p>
                    <ul class="list-disc pl-4 space-y-1">
                        <li><strong>Express Mode:</strong> 10% OFF (For high value docs > $100).</li>
                        <li><strong>Student ID:</strong> 20% OFF Final Fee.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-faq" class="fixed inset-0 bg-black/95 info-modal hidden items-center justify-center p-4">
        <div class="w-full max-w-2xl bg-[#0f172a] p-8 rounded-xl border border-[#d4af37]/30 shadow-2xl relative max-h-[80vh] overflow-y-auto">
            <button onclick="closeInfoModal('faq')" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
            <h3 class="text-xl text-[#d4af37] brand-font mb-6">Frequently Asked Questions</h3>
            <div class="space-y-4 text-sm text-gray-300">
                <details class="bg-black/30 p-3 rounded border border-white/5 cursor-pointer">
                    <summary class="font-bold text-white hover:text-[#d4af37]">Is this legally binding?</summary>
                    <p class="mt-2 text-xs leading-relaxed">Essproof provides a secure evidentiary record of intent. While we use advanced biometrics and timestamps, admissibility depends on local laws and the discretion of the competent authority/court. It serves as powerful private evidence.</p>
                </details>
                <details class="bg-black/30 p-3 rounded border border-white/5 cursor-pointer">
                    <summary class="font-bold text-white hover:text-[#d4af37]">Can I delete a document?</summary>
                    <p class="mt-2 text-xs leading-relaxed">No. Once a document is "Sealed & Executed" and hashed to the blockchain/database, it is immutable. This ensures the integrity of the platform.</p>
                </details>
                <details class="bg-black/30 p-3 rounded border border-white/5 cursor-pointer">
                    <summary class="font-bold text-white hover:text-[#d4af37]">What happens if the other party doesn't sign?</summary>
                    <p class="mt-2 text-xs leading-relaxed">The document remains in "PENDING" status. You are only charged the full sealing fee upon creation, but the final cryptographic seal is only applied when all parties sign.</p>
                </details>
                <details class="bg-black/30 p-3 rounded border border-white/5 cursor-pointer">
                    <summary class="font-bold text-white hover:text-[#d4af37]">Is my video public?</summary>
                    <p class="mt-2 text-xs leading-relaxed">Absolutely not. Video affidavits are encrypted and accessible only via the specific Access Key held by the participants or via a authorized Judicial Code.</p>
                </details>
            </div>
        </div>
    </div>

    <div id="modal-contact" class="fixed inset-0 bg-black/95 info-modal hidden items-center justify-center p-4">
        <div class="w-full max-w-md bg-[#0f172a] p-8 rounded-xl border border-[#d4af37]/30 shadow-2xl relative">
            <button onclick="closeInfoModal('contact')" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
            <h3 class="text-xl text-[#d4af37] brand-font mb-2">Contact Support</h3>
            <p class="text-xs text-gray-400 mb-6">We usually respond within 24 hours.</p>
            <div class="space-y-3">
                <input type="email" id="contact-email" class="w-full input-field p-3 text-sm rounded" placeholder="Your Email Address">
                <input type="text" id="contact-subject" class="w-full input-field p-3 text-sm rounded" placeholder="Subject (e.g. Billing Issue)">
                <textarea id="contact-msg" class="w-full input-field p-3 text-sm rounded h-32 resize-none" placeholder="How can we help?"></textarea>
                <button onclick="sendContactForm()" class="w-full gold-btn py-3 rounded text-xs font-bold uppercase tracking-widest shadow-lg">Send Message</button>
            </div>
        </div>
    </div>

    <div id="modal-video-guide" class="fixed inset-0 bg-black/95 info-modal hidden items-center justify-center p-4">
        <div class="w-full max-w-3xl bg-[#0f172a] p-4 rounded-xl border border-[#d4af37]/30 shadow-2xl relative">
            <button onclick="closeInfoModal('video')" class="absolute top-4 right-4 text-gray-500 hover:text-white z-50"><i class="fas fa-times text-xl"></i></button>
            <div class="aspect-video bg-black rounded border border-white/10 flex flex-col items-center justify-center text-gray-500">
                <i class="fas fa-film text-5xl mb-4 opacity-50"></i>
                <p class="uppercase tracking-widest text-sm font-bold">Video Tutorial Coming Soon</p>
                <p class="text-xs mt-2">Our production team is finalizing the walkthrough.</p>
            </div>
        </div>
    </div>

    <!-- NEW: User Guide Modal (Translated) -->
    <div id="modal-guide" class="fixed inset-0 bg-black/95 info-modal hidden items-center justify-center p-4">
        <div class="w-full max-w-3xl bg-[#0f172a] p-8 rounded-xl border border-[#d4af37]/30 shadow-2xl relative max-h-[90vh] overflow-y-auto">
            <button onclick="closeInfoModal('guide')" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
            <h3 class="text-xl text-[#d4af37] brand-font mb-6 border-b border-white/10 pb-2">User Guide</h3>
            <div class="text-xs text-gray-300 space-y-4 leading-relaxed font-serif text-justify">
                <p>
                    <strong class="text-white block mb-1 text-sm">Privacy & Consent</strong>
                    With a strong emphasis on privacy preservation, respect for confidentiality of identity, and the security of instruments drafted and registered on this platform, we require explicit and transparent permission to collect user data solely for the purpose of issuing the intended instrument. This ensures adherence to indicators of validity, authenticity, and proof of the users' real will, consent, and intent.
                </p>
                <ol class="list-decimal pl-5 space-y-2">
                    <li>On the homepage, click on either the Left or Right panel to enter the Gateway.</li>
                    <li>In the Gateway, no email or mobile number is required. You can enter using only your Name, Surname, and National ID. Please note: Enter a 6-digit numeric code of your choice in the designated field and keep it safe for future access to your document records.</li>
                    <li>After entering your Name, National ID, and 6-digit code, you must select the document type: <strong>Express Document</strong> (Registration and issuance without video) or <strong>Premium Document</strong> (Registration and issuance with video recording).</li>
                    <li>After selecting the document type, ensure you read the three explained points. If you agree, check the boxes to proceed. If the boxes are not checked, the platform assumes you have changed your mind and does not have permission to receive or record your data; the confirmation button will not activate, and you must exit the platform.</li>
                </ol>

                <div class="bg-black/30 p-3 rounded border border-white/10 mt-4">
                    <strong class="text-[#d4af37] block mb-2">Supplementary Explanation:</strong>
                    <p class="mb-2"><strong>Express Version (Non-Video):</strong> Fast and professional. Suitable for everyday commercial documents. In this mode, the "Digital Signature" and "Document Text" are registered. Your Date, Time, IP Address, and GPS Location are also captured and noted in the document. No camera required.</p>
                    <p><strong>Premium Version ( Legal Evidentiary Standard):</strong> In this mode, in addition to the signature, a "Video Certificate" of your face and voice is recorded, in which you declare your intent, will, and consent with full sobriety. Timestamp, IP Address, and GPS Location are also captured and noted.</p>
                </div>

                <p class="mt-4">
                    <strong>Note:</strong> If the browser requests permission to access your Camera, IP, or GPS and you deny it, the process cannot continue, and no document will be issued. You must exit or restart the process, granting the necessary permissions. If you pay the fee but refuse to grant permission for data collection (resulting in non-registration), the fee is non-refundable. A new attempt will require a new payment.
                </p>

                <h4 class="text-white font-bold mt-6 mb-2">2. Single Party Document Guide (e.g., Will, Affidavit, Commitment)</h4>
                <ul class="list-disc pl-5 space-y-1">
                    <li><strong>Entry:</strong> Select Express or Premium. Enter Name, National ID, and a "6-Digit PIN".</li>
                    <li><strong>Setup:</strong> In the "Setup" section, select <strong>Single Party</strong>.</li>
                    <li><strong>Drafting:</strong> Choose a template (e.g., Last Will) and fill in the fields. You can edit the text in the right-hand box.</li>
                    <li><strong>Signing:</strong> Click "Initiate & Sign", pay the fee, and seal the document with a digital fingerprint or video.</li>
                    <li><strong>Result:</strong> Your document is immediately encrypted and stored in the "Repository". It is accessible for PDF generation or printing.</li>
                </ul>
                <p class="mt-2 italic text-gray-400">
                    Note: After confirming the draft and clicking the button, you are directed to payment. A "Back" button exists there for re-editing. However, <strong>after payment, editing is impossible</strong>, and the document locks. Please be careful during drafting.
                </p>
                <p class="mt-2">
                    In the signing screen, use the touch screen (mobile/tablet) or mouse (PC) to sign in the designated box. Then press the final confirmation button to seal the document. To view the original or get a PDF, go to the Repository.
                </p>

                <h4 class="text-white font-bold mt-6 mb-2">3. Multi-Party Contract Guide (e.g., Lease, Sale, Partnership)</h4>
                <p class="mb-2"><strong class="text-red-400">Vital Note:</strong> Parties can enter the "Secure Virtual Room" simultaneously or at different times to sign the joint document one after another.</p>
                
                <strong class="text-[#d4af37] block mt-2">Initiator's Duty:</strong>
                <ul class="list-disc pl-5 space-y-1">
                    <li>In "Setup", select <strong>Multi-Party</strong>.</li>
                    <li>Add the Names and IDs of other parties in the "Signatories" list.</li>
                    <li><strong>Warning:</strong> The platform is sensitive to the Name and ID entered by the Initiator. If entered incorrectly, the system will not accept other users. You must restart and repay if mistakes are made. This is a non-negotiable security measure.</li>
                    <li>Select the document template or fill the page. You can add/delete text as needed. Click confirm to proceed to payment.</li>
                    <li><strong>Important:</strong> Review carefully. After payment, the document is <strong>LOCKED</strong>. No edits are possible. The exact text will be shown to other parties for signing only.</li>
                </ul>

                <strong class="text-[#d4af37] block mt-4">Room Key (Critical):</strong>
                <p>After payment, the system gives you a <strong>15-Digit Room Key</strong>. Copy this code (bottom left) and send it to the other party via a secure messenger (WhatsApp/Telegram/Email).</p>

                <strong class="text-[#d4af37] block mt-4">Counterparty's Duty:</strong>
                <ul class="list-disc pl-5 space-y-1">
                    <li>Go to the main site (do not click Express/Premium panels).</li>
                    <li>At the bottom, find the <strong>"Enter 15-Digit Room Key"</strong> box.</li>
                    <li>Enter the code provided by the Initiator and click the arrow.</li>
                    <li>The system will verify your entry, ask for the 3 permissions, and direct you to the specific contract to read and sign.</li>
                </ul>

                <p class="mt-4">
                    <strong>Repository Access:</strong> To view signed documents or download them, click the <strong>Repository</strong> (Folder Icon) at the top. Enter your Name, National ID, and the 6-Digit PIN you created. You can print or backup your files there.
                </p>
            </div>
        </div>
    </div>
    <main class="w-full flex-grow flex flex-col relative">

        <div id="modal-payment" class="fixed inset-0 bg-black/95 hidden items-center justify-center p-4">
            <div class="w-full max-w-md bg-[#0f172a] p-0 rounded-xl border border-[#d4af37]/50 shadow-[0_0_60px_rgba(212,175,55,0.15)] relative overflow-hidden flex flex-col">
                <div class="bg-[#d4af37]/10 border-b border-[#d4af37]/30 p-6 text-center relative">
                    <button onclick="closePaymentModal()" class="absolute top-4 left-4 text-gray-400 hover:text-white text-[10px] uppercase font-bold border border-white/20 px-2 py-1 rounded"><i class="fas fa-arrow-left mr-1"></i> Back to Edit</button>
                    <div class="text-[#d4af37] text-4xl mb-2 mt-4"><i class="fas fa-file-invoice-dollar"></i></div>
                    <h3 class="text-xl text-white brand-font tracking-widest uppercase">Service Fee Calculation</h3>
                    <p class="text-[10px] text-gray-400 mt-1">PROFORMA INVOICE #<span id="inv-num">--</span></p>
                </div>
                <div class="p-6 space-y-4">
                    <div class="flex justify-between items-center text-sm border-b border-white/10 pb-2">
                        <span class="text-gray-400">Processing Tier</span>
                        <span id="pay-tier" class="text-white font-bold uppercase">--</span>
                    </div>
                    <div class="flex justify-between items-center text-xs">
                        <span class="text-gray-400">Base Fee (Standard Coverage)</span>
                        <span id="pay-base" class="text-white font-mono">$0.00</span>
                    </div>
                    <div class="flex justify-between items-center text-xs">
                        <span class="text-gray-400">Extra Signatories Fee</span>
                        <span id="pay-extra" class="text-white font-mono">$0.00</span>
                    </div>
                    
                    <div class="bg-black/30 p-3 rounded border border-white/10 mt-2">
                        <label class="text-[10px] text-[#d4af37] uppercase font-bold tracking-widest block mb-2">Student Discount (20%)</label>
                        <div class="flex gap-2">
                            <input type="text" id="pay-student-id" placeholder="Enter Student ID" class="flex-grow input-field p-2 text-xs rounded border-[#d4af37]/30">
                            <button onclick="applyStudentDiscount()" class="bg-[#d4af37]/20 text-[#d4af37] border border-[#d4af37] px-3 py-1 rounded text-[10px] font-bold hover:bg-[#d4af37] hover:text-black transition">APPLY</button>
                        </div>
                    </div>

                    <div class="mt-4 pt-4 border-t border-[#d4af37]/30">
                        <div id="discount-display-container" class="hidden mb-2">
                            <div class="flex justify-between items-center text-xs text-gray-500">
                                <span>Standard Fee:</span>
                                <span id="pay-original" class="line-through decoration-red-500">$0.00</span>
                            </div>
                            <div class="flex justify-between items-center text-xs text-green-400">
                                <span>Discount Applied:</span>
                                <span id="pay-discount">-$0.00</span>
                            </div>
                        </div>

                        <div class="flex justify-between items-center">
                            <span class="text-[#d4af37] text-xs font-bold uppercase tracking-widest">Total Amount Due</span>
                            <span id="pay-total" class="text-2xl text-[#d4af37] font-mono font-bold">$0.00</span>
                        </div>
                    </div>
                </div>
                <div class="p-6 pt-0">
                    <button onclick="processPayment()" id="btn-pay-confirm" class="w-full gold-btn py-4 rounded text-xs font-bold uppercase tracking-widest shadow-lg flex justify-center items-center gap-2">
                        <span>Pay & Proceed to Sign</span> <i class="fas fa-chevron-right"></i>
                    </button>
                    <p class="text-[9px] text-center text-gray-600 mt-3"><i class="fas fa-lock mr-1"></i> 256-bit Secure SSL Payment</p>
                </div>
            </div>
        </div>

        <div id="modal-repo-login" class="fixed inset-0 bg-black/95 z-[9000] hidden items-center justify-center p-4">
            <div class="w-full max-w-sm bg-[#0f172a] p-8 rounded-xl border border-[#d4af37]/30 shadow-[0_0_50px_rgba(212,175,55,0.2)] relative text-center">
                <button onclick="document.getElementById('modal-repo-login').classList.add('hidden'); document.getElementById('modal-repo-login').classList.remove('flex');" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
                <div class="w-16 h-16 bg-[#d4af37]/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-[#d4af37]/50">
                    <i class="fas fa-user-lock text-3xl text-[#d4af37]"></i>
                </div>
                <h3 class="text-xl text-white brand-font mb-2">Identify Yourself</h3>
                <p class="text-xs text-gray-400 mb-6">Enter your details to access your personal secure vault.</p>
                <div class="space-y-3 text-left">
                    <div>
                        <label class="text-[10px] text-[#d4af37] uppercase font-bold tracking-widest pl-1">Legal Name</label>
                        <input type="text" id="login-name" class="w-full input-field p-3 text-sm rounded border-[#d4af37]/20 focus:border-[#d4af37]" placeholder="e.g. John Doe">
                    </div>
                    <div>
                        <label class="text-[10px] text-[#d4af37] uppercase font-bold tracking-widest pl-1">ID Number</label>
                        <input type="text" id="login-nid" class="w-full input-field p-3 text-sm rounded border-[#d4af37]/20 focus:border-[#d4af37]" placeholder="Unique Identifier">
                    </div>
                    <div>
                        <label class="text-[10px] text-[#d4af37] uppercase font-bold tracking-widest pl-1">Security PIN</label>
                        <input type="password" id="login-pin" maxlength="6" inputmode="numeric" class="w-full input-field p-3 text-sm rounded border-[#d4af37]/20 focus:border-[#d4af37]" placeholder="Enter 6-Digit PIN">
                    </div>
                    <button onclick="performLogin()" class="w-full gold-btn py-3 rounded text-xs font-bold uppercase tracking-widest shadow-lg mt-2">
                        Access My Documents
                    </button>
                </div>
            </div>
        </div>

        <div id="modal-judiciary-auth" class="fixed inset-0 bg-black/95 z-[60] hidden flex items-center justify-center p-4">
            <div class="w-full max-w-md bg-[#0f172a] p-8 rounded-xl border border-[#d4af37]/30 shadow-[0_0_50px_rgba(212,175,55,0.2)] relative">
                <button onclick="document.getElementById('modal-judiciary-auth').classList.add('hidden')" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
                <div class="text-center mb-8">
                    <i class="fas fa-university text-4xl text-[#d4af37] mb-4"></i>
                    <h2 class="text-2xl text-white brand-font">Authorized Portal</h2>
                    <p class="text-xs text-gray-400 mt-2">Access for Competent Authorities</p>
                </div>
                <div class="space-y-4">
                    <input type="password" id="judge-token" class="w-full input-field p-3 text-sm rounded border-[#d4af37]/20" placeholder="Enter One-Time Access Code">
                    <input type="text" id="judge-target" class="w-full input-field p-3 text-sm rounded border-[#d4af37]/20" placeholder="e.g. 84920193">
                    <button onclick="authenticateJudge()" class="w-full gold-btn font-bold py-3 rounded text-xs uppercase tracking-widest shadow-lg mt-2">
                        <i class="fas fa-shield-alt mr-2"></i> Access Evidence Vault
                    </button>
                </div>
            </div>
        </div>

        <div id="modal-judiciary-view" class="fixed inset-0 bg-[#02040a] z-[70] hidden overflow-hidden">
            <div class="container mx-auto px-4 py-8 h-full overflow-y-auto mr-10 custom-scrollbar">
                <div class="flex justify-between items-center mb-8 border-b border-[#d4af37]/30 pb-4">
                    <div class="flex items-center gap-4">
                        <div class="p-3 bg-[#d4af37]/10 rounded border border-[#d4af37]/30"><i class="fas fa-balance-scale text-2xl text-[#d4af37]"></i></div>
                        <div><h2 class="text-2xl text-white brand-font">Authorized Review Interface</h2><p class="text-xs text-gray-400">Mode: <span class="text-[#d4af37] font-bold uppercase">Read-Only / Forensic View</span></p></div>
                    </div>
                    <button onclick="closeJudiciaryView()" class="px-6 py-2 border border-red-500/50 text-red-500 hover:bg-red-900/20 rounded text-xs uppercase font-bold transition">Close Session</button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    <div class="lg:col-span-5 space-y-6">
                        <div class="bg-[#0f172a] p-6 rounded-lg border border-[#d4af37]/20">
                            <h4 class="text-xs text-[#d4af37] font-bold uppercase border-b border-[#d4af37]/30 pb-2 mb-4">Forensic Metadata</h4>
                            <div class="space-y-4 font-mono text-[10px]">
                                <div><span class="text-gray-500 block">Unique Document Code</span><span class="text-[#d4af37] text-lg font-bold" id="judge-doc-number">--</span></div>
                                <div><span class="text-gray-500 block">Global Document Hash (SHA-256)</span><span class="text-[#d4af37] break-all" id="judge-doc-hash">--</span></div>
                                <div><span class="text-gray-500 block">Creation Time (UTC)</span><span class="text-white" id="judge-time">--</span></div>
                            </div>
                        </div>
                        <div class="bg-black/40 border border-white/10 rounded-lg p-4">
                            <h4 class="text-[10px] text-gray-500 uppercase tracking-widest mb-4"><i class="fas fa-users mr-1"></i> Signatories & Affidavits</h4>
                            <div id="judge-sigs" class="space-y-2"></div>
                        </div>
                    </div>
                    <div class="lg:col-span-7">
                        <div id="judge-controls" class="mb-4"></div>
                        <div id="judge-doc-container"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="modal-dashboard" class="fixed inset-0 bg-black/95 z-50 hidden flex items-center justify-center p-4">
            <div class="w-full max-w-6xl glass-panel p-8 rounded-xl relative border-t-4 border-[#d4af37] flex flex-col max-h-[85vh]">
                <button onclick="closeDashboard()" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i class="fas fa-times text-xl"></i></button>
                <div class="flex items-center gap-4 mb-6 flex-shrink-0">
                    <div class="p-3 bg-[#d4af37]/10 rounded-full border border-[#d4af37]"><i class="fas fa-vault text-2xl text-[#d4af37]"></i></div>
                    <div><h2 class="text-3xl text-white brand-font">Secure Repository</h2><p class="text-xs text-gray-400 uppercase tracking-widest">Digital Evidence Vault: <span id="dash-user" class="text-white">Active Session</span></p></div>
                </div>
                <div class="flex flex-col md:flex-row gap-3 mb-4">
                    <div class="flex-1"><input id="repo-filter" type="search" placeholder="Search by Code, Name, or Type..." class="w-full input-field p-3 text-xs rounded focus-outline"></div>
                    <button onclick="renderRepo()" class="text-[11px] px-4 py-2 border border-white/10 rounded text-gray-200 hover:bg-white/5 whitespace-nowrap">Refresh</button>
                </div>
                <div class="overflow-y-auto flex-grow pr-2" style="min-height: 200px;">
                    <table class="w-full text-left text-sm text-gray-400 ledger-table">
                        <thead class="uppercase text-[10px] text-gray-500 border-b border-gray-800 bg-[#0d1326] sticky top-0 z-10">
                            <tr><th class="py-3 pl-4 rounded-tl-lg">Status</th><th class="py-3">Code</th><th class="py-3">Instrument Type</th><th class="py-3">Parties</th><th class="py-3">Date</th><th class="py-3 text-right pr-4 rounded-tr-lg">Action</th></tr>
                        </thead>
                        <tbody id="repo-body" class="divide-y divide-gray-800"></tbody>
                    </table>
                </div>
                <div class="mt-4 pt-4 border-t border-white/5 flex flex-col md:flex-row gap-4 justify-between items-center flex-shrink-0">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="chk-custody" class="legal-checkbox">
                        <label for="chk-custody" class="text-[10px] text-gray-300 uppercase cursor-pointer hover:text-white font-bold">Request Secure Physical Custody</label>
                        <button onclick="requestCustody()" class="text-[10px] bg-[#d4af37] text-black font-bold px-4 py-2 rounded hover:bg-white hover:text-black transition flex items-center gap-2"><i class="fas fa-archive"></i> SUBMIT REQUEST</button>
                    </div>
                    <div class="flex gap-2">
                        <input type="file" id="import-file" class="hidden" onchange="importBackup(this)">
                        <button onclick="document.getElementById('import-file').click()" class="text-xs px-4 py-3 border border-white/10 rounded text-gray-300 hover:bg-white/5 whitespace-nowrap"><i class="fas fa-file-import mr-1"></i> Import Backup</button>
                        <button onclick="exportBackup()" class="text-xs px-4 py-3 border border-white/10 rounded text-gray-300 hover:bg-white/5 whitespace-nowrap"><i class="fas fa-file-export mr-1"></i> Export Backup</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="modal-repo-detail" class="fixed inset-0 bg-black/95 hidden items-center justify-center p-4">
            <div class="w-full max-w-6xl bg-[#0f172a] p-6 rounded-xl border border-white/10 relative max-h-[90vh] overflow-y-auto">
                <button onclick="closeRepoDetail()" class="absolute top-3 right-3 text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
                <div id="repo-detail-body" class="flex flex-col h-full"></div>
            </div>
        </div>

        <div id="modal-video" class="fixed inset-0 bg-black/90 z-[10000] hidden items-center justify-center p-4">
            <div class="w-full max-w-2xl max-h-[90vh] bg-[#0f172a] p-4 rounded-xl border border-white/10 relative flex flex-col">
                <button onclick="closeVideoModal()" class="absolute top-3 right-3 text-gray-400 hover:text-white z-50"><i class="fas fa-times text-xl"></i></button>
                <div class="flex-grow overflow-hidden flex items-center justify-center bg-black rounded-lg"><video id="evidence-player" controls class="w-full max-h-full object-contain"></video></div>
                <div class="text-center mt-3 text-white font-mono text-xs">Video Evidence Playback</div>
            </div>
        </div>

        <div id="sec-hub" class="w-full">
            <div class="split-container fade-in">
                
                <div class="split-side side-express" onclick="startNewFlow()">
                    <i class="fas fa-file-signature text-5xl mb-6 text-[#d4af37]"></i> <h2 class="text-3xl font-black brand-font mb-2">ESSPROOF EXPRESS</h2>
                    <p class="text-xs font-bold uppercase tracking-widest text-[#f7ef8a]">Professional & Efficient</p>
                    
                    <ul class="feature-list">
                        <li><i class="fas fa-bolt feature-icon"></i> Instant Drafting (3 Mins)</li>
                        <li><i class="fas fa-pen-nib feature-icon"></i> Digital Signature</li>
                        <li><i class="fas fa-user-shield feature-icon"></i> No Camera Required</li>
                        <li><i class="fas fa-file-pdf feature-icon"></i> Standard PDF Output</li>
                    </ul>

                    <button class="btn-action">Start Express</button>
                </div>

                <div class="split-side side-premium" onclick="startNewFlow()">
                    <i class="fas fa-shield-alt text-5xl mb-6 text-[#d4af37]"></i>
                    <h2 class="text-3xl font-black brand-font mb-2">ESSPROOF PREMIUM</h2>
                    <p class="text-xs font-bold uppercase tracking-widest text-[#f7ef8a]">The Ultimate Standard</p>
                    
                    <ul class="feature-list">
                        <li><i class="fas fa-video feature-icon"></i> Biometric Video Proof</li>
                        <li><i class="fas fa-fingerprint feature-icon"></i> Forensic Metadata</li>
                        <li><i class="fas fa-link feature-icon"></i> Blockchain Timestamp</li>
                        <li><i class="fas fa-gavel feature-icon"></i> Judiciary Ready</li>
                    </ul>

                    <button class="btn-action">Start Premium</button>
                </div>

                <div class="room-join-bar">
                    <i class="fas fa-key text-[#d4af37]"></i>
                    <input type="text" id="manual-token" placeholder="Enter 15-Digit Room Key..." autocomplete="off" class="bg-transparent border-none text-white text-sm font-mono w-full focus:outline-none placeholder-gray-500">
                    <button onclick="processToken()" class="text-[#d4af37] hover:text-white transition"><i class="fas fa-arrow-right"></i></button>
                </div>

            </div>
        </div>

        <div class="w-full flex justify-center"> 
            <section id="sec-auth" class="w-full max-w-xl glass-panel p-10 rounded-xl hidden relative overflow-hidden fade-in mt-10 mb-10">
                <button onclick="location.reload()" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
                <div class="text-center mb-6">
                    <div class="relative w-24 h-24 mx-auto mb-4 border border-[#d4af37]/30 rounded-full flex items-center justify-center bg-black/50">
                        <i class="fas fa-user-astronaut text-5xl text-[#d4af37]"></i>
                        <div id="bio-scan-line" class="scan-line hidden"></div>
                    </div>
                    <h2 class="text-2xl text-white brand-font">Identity Gateway</h2>
                </div>
                <div id="auth-warning" class="hidden mb-6 bg-[#d4af37]/20 border border-[#d4af37]/30 p-3 rounded text-[10px] text-[#d4af37]"><i class="fas fa-lock mr-1"></i> Joining Document: <span id="target-doc-name" class="font-bold text-white">--</span></div>
                <div class="space-y-4">
                    <input type="text" id="auth-name" class="w-full input-field p-3 text-sm rounded" placeholder="Your Legal Name">
                    <input type="text" id="auth-nid" class="w-full input-field p-3 text-sm rounded" placeholder="Your National ID (Key)">
                    
                    <input type="password" id="auth-pin" maxlength="6" inputmode="numeric" class="w-full input-field p-3 text-sm rounded border-[#d4af37]/30 focus:border-[#d4af37]" placeholder="Create 6-Digit Security PIN (0-9)">

                    <div class="bg-black/60 border border-white/20 rounded p-4 mb-4" id="mode-selector-container">
                        <label class="block text-[10px] text-[#d4af37] uppercase font-bold tracking-widest mb-3 text-center">Select Security Protocol</label>
                        <div class="flex bg-[#0b1021] rounded p-1 border border-white/10">
                            <button id="mode-btn-video" onclick="setAuthMode('video')" class="flex-1 py-2 text-xs font-bold rounded uppercase transition bg-[#d4af37] text-black">
                                <i class="fas fa-video mr-1"></i> Shield (Video)
                            </button>
                            <button id="mode-btn-text" onclick="setAuthMode('text')" class="flex-1 py-2 text-xs font-bold rounded uppercase transition text-gray-500 hover:text-white">
                                <i class="fas fa-file-alt mr-1"></i> Standard (Text)
                            </button>
                        </div>
                        <p id="mode-desc" class="text-[9px] text-gray-400 mt-2 text-center italic">Highest security. Requires Camera & Microphone.</p>
                    </div>

                    <div class="bg-black/40 border border-white/10 rounded p-4 text-[13px] text-gray-400 space-y-3 mt-4 mb-4">
                        <h4 class="text-[#d4af37] font-bold uppercase tracking-widest border-b border-white/5 pb-2 mb-2">Mandatory Legal Consent</h4>
                        <div class="flex gap-3 items-start"><input type="checkbox" id="chk-1" class="legal-checkbox" onchange="validateConsent()"><label for="chk-1" id="lbl-chk-1" class="text-[12px] md:text-[13px] cursor-pointer hover:text-white transition"><strong class="text-white">1. Forensic Data Consent:</strong> I explicitly authorize the recording of my Biometrics (Video/Audio), Geolocation (GPS), and Device Fingerprint (IP) to generate an evidentiary package.</label></div>
                        <div class="flex gap-3 items-start"><input type="checkbox" id="chk-2" class="legal-checkbox" onchange="validateConsent()"><label for="chk-2" class="text-[12px] md:text-[13px] cursor-pointer hover:text-white transition"><strong class="text-white">2. Private Entity Notice:</strong>I acknowledge that Essproof is a private, independent forensic technology platform and does not function as, or substitute for, any government-mandated notarial, judicial, or public institution.</label></div>
                        <div class="flex gap-3 items-start"><input type="checkbox" id="chk-3" class="legal-checkbox" onchange="validateConsent()"><label for="chk-3" class="text-[12px] md:text-[13px] cursor-pointer hover:text-white transition"><strong class="text-white">3. Admissibility & Waiver:</strong> I understand that any evidentiary materials generated may be submitted in legal proceedings to demonstrate my intent, subject to the discretion of the competent authority.</label></div>
                    </div>
                    <button id="btn-auth" onclick="submitAuth()" class="w-full gold-btn py-3 rounded opacity-50 cursor-not-allowed grayscale" disabled>Verify Biometrics</button>
                </div>
                <p id="bio-status" class="text-center text-[10px] font-mono text-[#d4af37] mt-4 hidden">INITIALIZING SCAN...</p>
            </section>
        </div>
        <section id="sec-create" class="w-full max-w-6xl glass-panel p-8 rounded-xl hidden fade-in mx-auto mt-10">
            <div class="flex justify-between items-center mb-6 border-b border-white/10 pb-4">
                <h2 class="text-2xl text-white brand-font">Smart Drafting Studio</h2>
                <span class="text-white font-bold text-sm" id="creator-name-display">--</span>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-4 space-y-6 max-h-[500px] overflow-y-auto pr-2">
                    <div>
                        <label class="block text-[10px] text-[#d4af37] mb-2 uppercase font-bold tracking-widest">Setup</label>
                        <select id="contract-mode" class="w-full input-field p-3 text-sm rounded bg-[#0b1021]" onchange="toggleMode()">
                            <option value="multi">Multi-Party Contract</option>
                            <option value="single">Single Party (Solo)</option>
                        </select>
                    </div>
                    <div id="template-section">
                        <label class="block text-[10px] text-[#d4af37] mb-2 uppercase font-bold tracking-widest">Select Template</label>
                        <select id="template-select" class="w-full input-field p-3 text-sm rounded bg-[#0b1021]" onchange="loadTemplateInputs()">
                            <option value="">-- Choose Instrument --</option>
                            <option value="promissory">1. Promissory Note (IOU)</option>
                            <option value="vehicle">2. Vehicle Sale Agreement</option>
                            <option value="rent">3. Residential Lease</option>
                            <option value="nda">4. Non-Disclosure Agreement</option>
                            <option value="freelance">5. Freelance Service Contract</option>
                            <option value="poa">6. Limited Power of Attorney</option>
                            <option value="will">7. Last Will & Testament</option>
                            <option value="partnership">8. Partnership Agreement</option>
                            
                            <!-- NEW TEMPLATES ADDED HERE -->
                            <option value="contractor">9. Independent Contractor Agreement</option>
                            <option value="cease">10. Cease and Desist Letter</option>
                            <option value="loi">11. Letter of Intent (Business)</option>
                            <option value="sublease">12. Residential Sublease Agreement</option>
                            <option value="equipment">13. Equipment Lease Agreement</option>
                            <option value="consulting">14. Consulting Agreement</option>
                            <option value="waiver">15. Release of Liability (Waiver)</option>
                            <option value="demand">16. Demand Letter (Payment)</option>
                            <option value="residence">17. Affidavit of Residence</option>
                            <option value="ip_assign">18. IP Assignment Agreement</option>
                            <option value="joint_venture">19. Joint Venture Agreement</option>
                            <option value="loan_secured">20. Loan Agreement (Secured)</option>
                            <option value="tos">21. Website Terms of Service</option>
                            <option value="privacy">22. Website Privacy Policy</option>
                            <option value="offer_letter">23. Employment Offer Letter</option>
                            <option value="sales_agency">24. Sales Agency Agreement</option>
                            <option value="event_rental">25. Event Space Rental</option>
                            <option value="photo_service">26. Photography Services Contract</option>
                            <option value="eula">27. Software License (EULA)</option>
                            <option value="debt_settlement">28. Debt Settlement Agreement</option>

                            <!-- NEW 12 TEMPLATES -->
                            <option value="general_contractor">29. General Contractor Agreement</option>
                            <option value="property_mgmt">30. Property Management Agreement</option>
                            <option value="internship">31. Internship Agreement</option>
                            <option value="referral">32. Referral Commission Agreement</option>
                            <option value="sponsorship">33. Sponsorship Agreement</option>
                            <option value="model_release">34. Model Release Form</option>
                            <option value="roommate">35. Roommate Agreement</option>
                            <option value="pet_sitting">36. Pet Sitting Agreement</option>
                            <option value="tutoring">37. Tutoring Contract</option>
                            <option value="volunteer">38. Volunteer Agreement</option>
                            <option value="gym_waiver">39. Gym/Fitness Waiver</option>
                            <option value="software_dev">40. Software Development Agreement</option>

                            <option value="custom">Custom (Blank)</option>
                        </select>
                    </div>
                    <div id="smart-inputs" class="space-y-3 hidden bg-white/5 p-4 rounded border border-white/10"></div>
                    <div id="roster-section" class="bg-white/5 p-4 rounded border border-white/10">
                        <div class="flex justify-between items-center mb-4">
                            <label class="text-[10px] text-[#d4af37] font-bold uppercase tracking-widest">Signatories</label>
                            <button onclick="addRow()" class="text-[10px] bg-[#d4af37]/20 text-[#d4af37] border border-[#d4af37]/50 px-2 py-1 rounded hover:bg-[#d4af37] hover:text-black transition"><i class="fas fa-plus"></i> Add</button>
                        </div>
                        <div id="roster-list" class="space-y-2 max-h-40 overflow-y-auto pr-1"></div>
                    </div>
                </div>
                <div class="lg:col-span-8 flex flex-col">
                    <div class="flex justify-between mb-2">
                        <label class="block text-[10px] text-gray-500 uppercase">Live Document Preview</label>
                        <span class="text-[9px] text-[#d4af37] uppercase">Auto-Generated & Editable</span>
                    </div>
                    <!-- CHANGED: Textarea replaced with ContentEditable DIV for Smart Editing -->
                    <div id="create-text" class="w-full flex-grow input-field p-8 text-gray-300 legal-font text-sm leading-7 rounded min-h-[400px] overflow-y-auto whitespace-pre-wrap" contenteditable="true">Select a template to generate text...</div>
                </div>
            </div>
            <div class="mt-8 flex justify-end border-t border-white/10 pt-4 relative">
                <button id="btn-force-sign" onclick="smartGoToSigning()" class="gold-btn px-10 py-4 shadow-lg text-sm tracking-widest hover:bg-[#b45309]">INITIATE & SIGN <i class="fas fa-arrow-right ml-2"></i></button>
            </div>
        </section>
<section id="sec-sign" class="w-full max-w-4xl glass-panel p-0 hidden rounded-xl overflow-hidden border border-white/10 fade-in mx-auto mt-10">
            <div class="grid grid-cols-1 md:grid-cols-2">
                <div class="bg-black p-8 flex flex-col justify-center items-center relative">
                    
                    <div id="video-container" class="w-full mb-4">
                        <div class="w-full aspect-square bg-[#111] border border-gray-800 rounded mb-4 relative overflow-hidden">
                            <video id="webcam" autoplay muted class="absolute inset-0 w-full h-full object-cover hidden"></video>
                            <div id="cam-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-gray-700"><i class="fas fa-camera text-3xl mb-2"></i></div>
                        </div>
                        <button id="btn-record" onclick="toggleRecord()" class="w-full border border-gray-700 text-gray-400 hover:text-white py-3 text-xs uppercase font-bold rounded">Record Affidavit</button>
                    </div>
                    
                    <div class="mb-4 w-full">
                        <label class="text-[10px] text-[#d4af37] uppercase font-bold tracking-widest block mb-2 text-center">Draw Signature</label>
                        <div class="border border-white/20 bg-white rounded relative h-32 md:h-40">
                            <canvas id="sig-canvas" class="w-full h-full cursor-crosshair touch-none bg-white rounded"></canvas>
                            <button onclick="clearSignature()" class="absolute top-2 right-2 text-[10px] text-red-600 font-bold hover:text-red-800 px-2 rounded"><i class="fas fa-trash"></i> Clear</button>
                        </div>
                    </div>
                </div>
                <div class="p-8 bg-[#0b1021] flex flex-col justify-center">
                    <h3 class="text-xl text-white brand-font mb-4">Proof of Volition</h3>
                    <p class="text-gray-400 text-sm italic mb-8">"I, <span id="sign-name-display" class="text-white font-bold">--</span>, holding ID <span id="sign-id-display" class="text-[#d4af37]">--</span>, hereby confirm that I am signing this instrument with my full knowledge, free will, informed consent, and without any coercion, duress, or undue influence."</p>
                    <button id="btn-seal" onclick="finalizeSigSimple()" class="gold-btn py-4 rounded w-full opacity-50 cursor-not-allowed" disabled>Cryptographic Seal</button>
                    <div id="process-status" class="hidden mt-4 text-center">
                        <p class="text-[10px] text-[#d4af37] font-mono">CAPTURING METADATA...</p>
                        <p class="text-[10px] text-[#d4af37] font-mono mt-1" id="meta-disp"></p>
                    </div>
                </div>
            </div>
        </section>

        <section id="sec-signing-room" class="w-full max-w-6xl glass-panel p-8 rounded-xl hidden border-t-4 border-[#d4af37] fade-in mx-auto mt-10">
            <div class="bg-green-900/30 border border-blue-500/50 p-4 rounded-lg mb-6 text-center shadow-lg">
                <i class="fas fa-info-circle text-blue-400 text-xl mb-2"></i>
                <h2 class="text-[15px] text-green-100 leading-relaxed font-bold">
                   NOTICE TO THE INITIATING PARTY : This procedure applies exclusively to bilateral or multilateral instruments.
Please copy the <span class="text-[#d4af37]">15-Digit Room Key</span> from the bottom-left box and share it with all other parties.
 
The initiating party is responsible for securely sharing the 15-Digit Room Key, with the other contractual party or parties solely through trusted and mutually agreed secure communication channels already in use between them.
Each counterparty must enter this key on the main screen in order to access the shared session and execute the joint signing of the instrument .</h2>
            </div>

            <div class="flex justify-between items-start mb-8 border-b border-white/10 pb-6">
                <div>
                    <h2 class="text-3xl text-white brand-font">Signing Room</h2>
                    <p class="text-[14px] text-gray-400 mt-1">Instrument ID: <span id="room-code" class="text-[#d4af37] font-mono font-bold">--</span></p>
                </div>
                <div class="text-right">
                    <span class="block text-[9px] text-gray-500 uppercase tracking-widest mb-1">Status</span>
                    <div id="room-status-text" class="text-xl text-white font-mono font-bold">--</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-4 flex flex-col h-full">
                    <div class="bg-[#0b1021] rounded-lg p-5 border border-white/10 h-full flex flex-col">
                        <h4 class="text-[10px] text-[#d4af37] uppercase tracking-widest mb-4 border-b border-white/10 pb-2">Participants</h4>
                        <div id="room-roster" class="flex-grow overflow-y-auto space-y-2">
                            </div>
                         
                        <div class="mt-6 pt-4 border-t border-white/10">
                            <p class="text-[11px] text-gray-500 mb-2 uppercase tracking-widest font-bold">Room Access Key (15-Digit)</p>
                            <div class="bg-black p-3 rounded border border-[#d4af37] text-[#d4af37] font-mono text-lg font-bold text-center tracking-widest cursor-pointer hover:bg-white/5 transition" onclick="copyToken()" id="room-token-box">--</div>
                             <div class="mt-2 flex gap-2">
                                <button id="btn-copy-token" onclick="copyToken()" class="flex-1 border border-white/20 text-white py-2 rounded text-[13px] hover:bg-white/10">Copy Key</button>
                                <button id="btn-print-room" onclick="printDocument(contract.id)" class="flex-1 bg-white text-black py-2 rounded text-[10px] font-bold hover:bg-gray-200 hidden">Print / PDF</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-8 flex flex-col">
                      <div id="room-action-area" class="mb-6 hidden">
                          <div class="bg-gradient-to-r from-[#d4af37]/20 to-transparent p-4 rounded border border-[#d4af37] flex justify-between items-center">
                              <div>
                                  <h4 class="text-white font-bold text-sm">Action Required</h4>
                                  <p class="text-[10px] text-gray-300">User: <span id="room-user-name" class="font-bold">--</span></p>
                              </div>
                              <button onclick="goToSigningSafe()" class="gold-btn px-6 py-3 rounded text-xs shadow-lg animate-pulse">PROCEED TO SIGN</button>
                          </div>
                      </div>
                      
                      <div id="room-sealed-area" class="mb-6 hidden">
                        <div class="bg-green-900/20 p-4 rounded border border-green-500/50 flex items-center justify-center gap-4">
                            <i class="fas fa-certificate text-3xl text-green-500"></i>
                            <div class="text-center">
                                <h4 class="text-green-400 font-bold text-sm uppercase tracking-widest">Officially Sealed & Executed</h4>
                                <p class="text-[10px] text-gray-400 font-mono" id="room-final-hash">--</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-[#fdfbf7] text-black p-8 shadow-inner relative min-h-[500px] overflow-y-auto rounded h-full">
                        <div class="absolute top-2 right-2 border border-red-800 text-red-800 px-2 text-[9px] font-bold uppercase rotate-12 opacity-50">Live Preview</div>
                        <h3 class="font-bold text-lg mb-4 uppercase border-b border-black/20 pb-2" id="room-doc-type">--</h3>
                        <p class="font-serif text-sm leading-relaxed whitespace-pre-line text-justify break-words" id="room-text">--</p>
                        
                        <div class="mt-12 pt-6 border-t-2 border-black/10">
                            <div class="text-[10px] font-bold uppercase mb-4 text-gray-500">Execution Block:</div>
                            <div id="room-sigs-preview" class="flex flex-wrap gap-8"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <footer class="border-t border-white/10 bg-[#02040a] py-6 mt-auto">
        <div class="container mx-auto px-6 text-center">
            <p class="text-[11px] text-gray-500 uppercase tracking-widest leading-relaxed">
                DISCLAIMER: This platform is exclusively for the registration of non-official, non-governmental, private (personal or multi-party) self-willed instruments.
            </p>
            <p class="text-[10px] text-gray-700 mt-2"> 2025 Essproof Systems. All Rights Reserved.</p>
        </div>
         </footer>
         <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAlfX416VJz5rx4rcbQE15FOUAEAf0eFCw",
            authDomain: "essproof-866ef.firebaseapp.com",
            databaseURL: "https://essproof-866ef-default-rtdb.firebaseio.com/",
            projectId: "essproof-866ef",
            storageBucket: "essproof-866ef.firebasestorage.app",
            messagingSenderId: "831180163230",
            appId: "1:831180163230:web:ddd865e353cee6d3a5938f"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- GLOBAL VARIABLES ---
        let selectedAuthMode = 'video';
        let user = { name: "", nid: "", pin: "" };
        let contract = null;
        let activeJudgeDoc = null;
        let activeDetailDoc = null;
        let selectedDocId = null;
        let isRec = false;
        let mediaRecorder=null, recChunks=[];
        let videoBlobCaptured = null;
        let pendingContractData = null;
        let canvas, ctx, isDrawing = false;
        
        // --- REAL FORENSIC DATA VARIABLES ---
        let userRealIP = "Detecting...";
        let userRealGPS = "Waiting for permission...";
        
        // GLOBAL FOR PAYMENT
        let currentPaymentRaw = 0; 
        
        // GLOBAL FOR SMART EDITING
        let inputHistory = {};

        // --- TEMPLATES (40 TOTAL) ---
        const TEMPLATES = {
            'promissory': { fields: ['Lender Name', 'Borrower Name', 'Amount', 'Currency', 'Repayment Date'], text: (d) => `PROMISSORY NOTE (IOU)\n\nLENDER: ${d['Lender Name']}\nBORROWER: ${d['Borrower Name']}\n\nFor value received, the Borrower promises to pay to the Lender the sum of ${d['Amount']} ${d['Currency']}.\n\nRepayment Date: ${d['Repayment Date']}\n\nI, the Borrower, acknowledge receiving the above amount and commit to repaying it in full.` },
            'vehicle': { fields: ['Seller Name', 'Buyer Name', 'Vehicle Model', 'VIN/Chassis', 'Price'], text: (d) => `VEHICLE SALE AGREEMENT\n\nSELLER: ${d['Seller Name']}\nBUYER: ${d['Buyer Name']}\n\nVehicle: ${d['Vehicle Model']}\nVIN: ${d['VIN/Chassis']}\n\nSale Price: ${d['Price']}\n\nThe Seller declares full ownership of the vehicle and confirms it is free of legal claims.` },
            'rent': { fields: ['Landlord', 'Tenant', 'Property Address', 'Monthly Rent', 'Duration (Months)', 'Start Date'], text: (d) => `RESIDENTIAL LEASE AGREEMENT\n\nLANDLORD: ${d['Landlord']}\nTENANT: ${d['Tenant']}\n\nProperty: ${d['Property Address']}\nRent: ${d['Monthly Rent']} per month\nDuration: ${d['Duration (Months)']} Months\n\nLease Start Date: ${d['Start Date']}\n\nThe Tenant agrees to pay rent on time and maintain the property in good condition.` },
            'nda': { fields: ['Disclosing Party', 'Receiving Party', 'Purpose'], text: (d) => `NON-DISCLOSURE AGREEMENT (NDA)\n\nBETWEEN: ${d['Disclosing Party']} AND ${d['Receiving Party']}\n\nPurpose: ${d['Purpose']}\n\nBoth parties agree to keep all exchanged information strictly confidential and use it solely for the purpose stated above.` },
            'freelance': { fields: ['Client', 'Freelancer', 'Scope of Work', 'Fee'], text: (d) => `FREELANCE SERVICE AGREEMENT\n\nCLIENT: ${d['Client']}\nFREELANCER: ${d['Freelancer']}\n\nScope: ${d['Scope of Work']}\nFee: ${d['Fee']}\n\nThe Freelancer agrees to deliver the work as specified. Ownership of the final work transfers to Client upon payment.` },
            'poa': { fields: ['Principal', 'Agent', 'Scope of Authority'], text: (d) => `LIMITED POWER OF ATTORNEY\n\nI, ${d['Principal']}, hereby appoint ${d['Agent']} as my attorney-in-fact.\n\nScope: ${d['Scope of Authority']}\n\nThis power is limited to the specific acts listed above and shall remain valid until revoked in writing.` },
            'will': { fields: ['Testator Name', 'Beneficiary 1', 'Beneficiary 2', 'Assets', 'Total Estate Value'], text: (d) => `LAST WILL AND TESTAMENT\n\nI, ${d['Testator Name']}, being of sound mind, declare this to be my Last Will.\n\nBeneficiaries:\n1. ${d['Beneficiary 1']}\n2. ${d['Beneficiary 2']}\n\nAssets Covered: ${d['Assets']}\n\nTotal Estimated Estate Value: ${d['Total Estate Value']}\n\nI hereby revoke all prior wills and codicils.` },
            'partnership': { fields: ['Partner 1', 'Partner 2', 'Business Purpose'], text: (d) => `PARTNERSHIP AGREEMENT\n\nPARTNERS: ${d['Partner 1']} and ${d['Partner 2']}\n\nPurpose: ${d['Business Purpose']}\n\nPartners agree to share profits and losses equally.` },
            'contractor': { fields: ['Client Name', 'Contractor Name', 'Services Provided', 'Compensation', 'End Date'], text: (d) => `INDEPENDENT CONTRACTOR AGREEMENT\n\nCLIENT: ${d['Client Name']}\nCONTRACTOR: ${d['Contractor Name']}\n\nServices: ${d['Services Provided']}\nCompensation: ${d['Compensation']}\nTerm End Date: ${d['End Date']}\n\nThe Contractor is an independent entity and not an employee. No tax withholdings shall be made by the Client.` },
            'cease': { fields: ['Sender Name', 'Recipient Name', 'Infringing Activity', 'Deadline Date'], text: (d) => `CEASE AND DESIST NOTICE\n\nFROM: ${d['Sender Name']}\nTO: ${d['Recipient Name']}\n\nRe: ${d['Infringing Activity']}\n\nYou are hereby formally notified to immediately CEASE AND DESIST the activity described above. Failure to comply by ${d['Deadline Date']} will result in further legal action.` },
            'loi': { fields: ['Buyer/Investor', 'Seller/Target', 'Proposed Transaction', 'Purchase Price'], text: (d) => `LETTER OF INTENT (LOI)\n\nBETWEEN: ${d['Buyer/Investor']} AND ${d['Seller/Target']}\n\nSubject: ${d['Proposed Transaction']}\nProposed Price: ${d['Purchase Price']}\n\nThis letter outlines the preliminary intent of the parties to enter into a formal agreement. This document is non-binding except for confidentiality provisions.` },
            'sublease': { fields: ['Original Tenant', 'Subtenant', 'Property Address', 'Monthly Rent', 'Duration (Months)'], text: (d) => `RESIDENTIAL SUBLEASE AGREEMENT\n\nSUBLESSOR: ${d['Original Tenant']}\nSUBLESSEE: ${d['Subtenant']}\n\nPremises: ${d['Property Address']}\nRent: ${d['Monthly Rent']}\nDuration: ${d['Duration (Months)']} Months\n\nThe Sublessee agrees to abide by all terms of the original Master Lease.` },
            'equipment': { fields: ['Lessor', 'Lessee', 'Equipment Description', 'Rental Rate', 'Duration (Days/Months)'], text: (d) => `EQUIPMENT LEASE AGREEMENT\n\nLESSOR: ${d['Lessor']}\nLESSEE: ${d['Lessee']}\n\nEquipment: ${d['Equipment Description']}\nRate: ${d['Rental Rate']}\nDuration: ${d['Duration (Days/Months)']}\n\nThe Lessee accepts the equipment in good condition and agrees to return it in the same condition, normal wear and tear excepted.` },
            'consulting': { fields: ['Company', 'Consultant', 'Project Scope', 'Hourly/Fixed Rate'], text: (d) => `CONSULTING AGREEMENT\n\nCOMPANY: ${d['Company']}\nCONSULTANT: ${d['Consultant']}\n\nScope: ${d['Project Scope']}\nRate: ${d['Hourly/Fixed Rate']}\n\nThe Consultant agrees to provide professional advice and services as an independent contractor.` },
            'waiver': { fields: ['Releasor', 'Releasee', 'Event/Activity', 'Date'], text: (d) => `RELEASE OF LIABILITY (WAIVER)\n\nI, ${d['Releasor']}, hereby release and forever discharge ${d['Releasee']} from any and all liability, claims, or demands arising from my participation in ${d['Event/Activity']} on ${d['Date']}.\n\nI voluntarily assume all risks associated with this activity.` },
            'demand': { fields: ['Creditor', 'Debtor', 'Amount Due', 'Original Invoice Ref', 'Deadline'], text: (d) => `FORMAL DEMAND FOR PAYMENT\n\nFROM: ${d['Creditor']}\nTO: ${d['Debtor']}\n\nAmount Outstanding: ${d['Amount Due']}\nReference: ${d['Original Invoice Ref']}\n\nDemand is hereby made for payment of the above amount by ${d['Deadline']}. Failure to pay may result in legal proceedings.` },
            'residence': { fields: ['Affiant Name', 'Address', 'City/State', 'Years at Address'], text: (d) => `AFFIDAVIT OF RESIDENCE\n\nI, ${d['Affiant Name']}, solemnly affirm that I currently reside at:\n${d['Address']}, ${d['City/State']}\n\nI have lived at this address for ${d['Years at Address']} years.\n\nI declare under penalty of perjury that the foregoing is true and correct.` },
            'ip_assign': { fields: ['Assignor', 'Assignee', 'Description of IP', 'Consideration'], text: (d) => `INTELLECTUAL PROPERTY ASSIGNMENT\n\nASSIGNOR: ${d['Assignor']}\nASSIGNEE: ${d['Assignee']}\n\nIP Description: ${d['Description of IP']}\nPayment: ${d['Consideration']}\n\nThe Assignor hereby transfers and assigns all rights, title, and interest in the described Intellectual Property to the Assignee.` },
            'joint_venture': { fields: ['Party A', 'Party B', 'Venture Name', 'Purpose'], text: (d) => `JOINT VENTURE AGREEMENT\n\nPARTICIPANTS: ${d['Party A']} and ${d['Party B']}\n\nVenture Name: ${d['Venture Name']}\nPurpose: ${d['Purpose']}\n\nThe parties agree to pool resources for the specific purpose stated above. This does not constitute a permanent partnership.` },
            'loan_secured': { fields: ['Lender', 'Borrower', 'Loan Amount', 'Collateral Description', 'Interest Rate'], text: (d) => `SECURED LOAN AGREEMENT\n\nLENDER: ${d['Lender']}\nBORROWER: ${d['Borrower']}\n\nPrincipal: ${d['Loan Amount']}\nInterest: ${d['Interest Rate']}\nCollateral: ${d['Collateral Description']}\n\nThis loan is secured by the collateral described. In the event of default, the Lender may seize the collateral.` },
            'tos': { fields: ['Website/App Name', 'Owner Company', 'Contact Email'], text: (d) => `TERMS OF SERVICE\n\nPlatform: ${d['Website/App Name']}\nOperator: ${d['Owner Company']}\n\nBy accessing this platform, users agree to be bound by these terms. All content is the property of the Operator.\n\nContact: ${d['Contact Email']}` },
            'privacy': { fields: ['Website Name', 'Data Collected', 'Data Usage Purpose'], text: (d) => `PRIVACY POLICY\n\nSite: ${d['Website Name']}\n\nWe collect the following data: ${d['Data Collected']}\nPurpose of Use: ${d['Data Usage Purpose']}\n\nWe are committed to protecting user privacy and will not sell data to third parties without consent.` },
            'offer_letter': { fields: ['Candidate Name', 'Company', 'Job Title', 'Annual Salary', 'Start Date'], text: (d) => `EMPLOYMENT OFFER LETTER\n\nDear ${d['Candidate Name']},\n\n${d['Company']} is pleased to offer you the position of ${d['Job Title']}.\n\nSalary: ${d['Annual Salary']} per year\nStart Date: ${d['Start Date']}\n\nThis offer is contingent upon successful background check and your acceptance.` },
            'sales_agency': { fields: ['Principal', 'Agent', 'Territory', 'Commission Rate'], text: (d) => `SALES AGENCY AGREEMENT\n\nPRINCIPAL: ${d['Principal']}\nAGENT: ${d['Agent']}\n\nTerritory: ${d['Territory']}\nCommission: ${d['Commission Rate']}\n\nThe Agent is authorized to solicit orders for the Principal's products within the Territory.` },
            'event_rental': { fields: ['Venue Owner', 'Renter', 'Event Date', 'Event Type', 'Total Fee', 'Duration (Hours)'], text: (d) => `EVENT SPACE RENTAL AGREEMENT\n\nOWNER: ${d['Venue Owner']}\nRENTER: ${d['Renter']}\n\nDate: ${d['Event Date']}\nEvent: ${d['Event Type']}\nFee: ${d['Total Fee']}\nDuration: ${d['Duration (Hours)']} Hours\n\nThe Renter agrees to vacate the premises by the agreed time and leave the space in clean condition.` },
            'photo_service': { fields: ['Photographer', 'Client', 'Event/Shoot Type', 'Deliverables', 'Fee'], text: (d) => `PHOTOGRAPHY SERVICES CONTRACT\n\nPHOTOGRAPHER: ${d['Photographer']}\nCLIENT: ${d['Client']}\n\nShoot: ${d['Event/Shoot Type']}\nDeliverables: ${d['Deliverables']}\nFee: ${d['Fee']}\n\nThe Photographer retains copyright but grants the Client a license for personal/commercial use as agreed.` },
            'eula': { fields: ['Software Name', 'Licensor', 'Licensee', 'License Type'], text: (d) => `END USER LICENSE AGREEMENT (EULA)\n\nSoftware: ${d['Software Name']}\nLicensor: ${d['Licensor']}\n\nThis license grants the Licensee a ${d['License Type']} right to use the software. Reverse engineering and redistribution are strictly prohibited.` },
            'debt_settlement': { fields: ['Creditor', 'Debtor', 'Total Debt', 'Settlement Amount', 'Payment Date'], text: (d) => `DEBT SETTLEMENT AGREEMENT\n\nCREDITOR: ${d['Creditor']}\nDEBTOR: ${d['Debtor']}\n\nTotal Debt: ${d['Total Debt']}\nSettlement Amount: ${d['Settlement Amount']}\n\nThe Creditor agrees to accept the Settlement Amount as full and final satisfaction of the Total Debt if paid by ${d['Payment Date']}.` },
            'general_contractor': { fields: ['Property Owner', 'Contractor', 'Project Address', 'Total Cost', 'Completion Date'], text: (d) => `GENERAL CONTRACTOR AGREEMENT\n\nOWNER: ${d['Property Owner']}\nCONTRACTOR: ${d['Contractor']}\n\nProject Location: ${d['Project Address']}\nTotal Cost: ${d['Total Cost']}\nEst. Completion: ${d['Completion Date']}\n\nThe Contractor agrees to provide all labor and materials to complete the project according to the specifications.` },
            'property_mgmt': { fields: ['Owner', 'Manager', 'Property Address', 'Management Fee (%)'], text: (d) => `PROPERTY MANAGEMENT AGREEMENT\n\nOWNER: ${d['Owner']}\nMANAGER: ${d['Manager']}\n\nProperty: ${d['Property Address']}\nFee: ${d['Management Fee (%)']} of gross rent\n\nThe Manager is appointed to manage, lease, and operate the property on behalf of the Owner.` },
            'internship': { fields: ['Company', 'Intern', 'Role', 'Stipend (if any)', 'Duration'], text: (d) => `INTERNSHIP AGREEMENT\n\nCOMPANY: ${d['Company']}\nINTERN: ${d['Intern']}\n\nRole: ${d['Role']}\nStipend: ${d['Stipend (if any)']}\nDuration: ${d['Duration']}\n\nThis internship is for educational purposes. The Intern agrees to follow company policies and maintain confidentiality.` },
            'referral': { fields: ['Company', 'Referrer', 'Commission Amount', 'Payment Terms'], text: (d) => `REFERRAL COMMISSION AGREEMENT\n\nCOMPANY: ${d['Company']}\nREFERRER: ${d['Referrer']}\n\nCommission: ${d['Commission Amount']} per successful referral\nTerms: ${d['Payment Terms']}\n\nThe Company agrees to pay the Referrer for qualified leads that result in sales.` },
            'sponsorship': { fields: ['Sponsor', 'Recipient', 'Event/Project', 'Sponsorship Amount'], text: (d) => `SPONSORSHIP AGREEMENT\n\nSPONSOR: ${d['Sponsor']}\nRECIPIENT: ${d['Recipient']}\n\nEvent: ${d['Event/Project']}\nAmount: ${d['Sponsorship Amount']}\n\nThe Sponsor agrees to provide funds in exchange for promotional rights as agreed.` },
            'model_release': { fields: ['Model Name', 'Photographer', 'Shoot Date', 'Compensation'], text: (d) => `MODEL RELEASE FORM\n\nI, ${d['Model Name']}, grant ${d['Photographer']} the irrevocable right to use my image/likeness from the shoot on ${d['Shoot Date']}.\n\nCompensation: ${d['Compensation']}\n\nI hereby waive any right to inspect or approve the finished product.` },
            'roommate': { fields: ['Roommate 1', 'Roommate 2', 'Address', 'Rent Share', 'Utility Split'], text: (d) => `ROOMMATE AGREEMENT\n\nBETWEEN: ${d['Roommate 1']} AND ${d['Roommate 2']}\n\nAddress: ${d['Address']}\nRent Share: ${d['Rent Share']} each\nUtilities: ${d['Utility Split']}\n\nRoommates agree to share household responsibilities and respect common areas.` },
            'pet_sitting': { fields: ['Owner', 'Sitter', 'Pet Name(s)', 'Rate', 'Dates'], text: (d) => `PET SITTING AGREEMENT\n\nOWNER: ${d['Owner']}\nSITTER: ${d['Sitter']}\n\nPet(s): ${d['Pet Name(s)']}\nRate: ${d['Rate']}\nDates: ${d['Dates']}\n\nThe Sitter agrees to care for the pets and property with due diligence.` },
            'tutoring': { fields: ['Tutor', 'Student', 'Subject', 'Hourly Rate', 'Schedule'], text: (d) => `TUTORING CONTRACT\n\nTUTOR: ${d['Tutor']}\nSTUDENT: ${d['Student']}\n\nSubject: ${d['Subject']}\nRate: ${d['Hourly Rate']}\nSchedule: ${d['Schedule']}\n\nThe Tutor agrees to provide instruction in the subject matter. Cancellations require 24-hour notice.` },
            'volunteer': { fields: ['Organization', 'Volunteer', 'Role', 'Start Date'], text: (d) => `VOLUNTEER AGREEMENT\n\nORG: ${d['Organization']}\nVOLUNTEER: ${d['Volunteer']}\n\nRole: ${d['Role']}\nStart Date: ${d['Start Date']}\n\nThe Volunteer agrees to provide services without compensation and adhere to the organization's code of conduct.` },
            'gym_waiver': { fields: ['Participant', 'Gym/Facility', 'Date'], text: (d) => `GYM/FITNESS WAIVER\n\nI, ${d['Participant']}, acknowledge the risks inherent in physical exercise at ${d['Gym/Facility']}.\n\nDate: ${d['Date']}\n\nI voluntarily assume all risks of injury and release the facility from liability.` },
            'software_dev': { fields: ['Client', 'Developer', 'Project Name', 'Total Cost', 'Milestones'], text: (d) => `SOFTWARE DEVELOPMENT AGREEMENT\n\nCLIENT: ${d['Client']}\nDEVELOPER: ${d['Developer']}\n\nProject: ${d['Project Name']}\nCost: ${d['Total Cost']}\nMilestones: ${d['Milestones']}\n\nThe Developer assigns all code and IP rights to the Client upon full payment.` },
            'custom': { fields: [], text: (d) => `` }
        };

        const PricingEngine = {
            calculate: (contractValue, partyCount, mode, docType) => {
                let baseFee = 0;
                let isFinancial = false;

                if (docType === 'will') {
                    isFinancial = true; 
                    if (contractValue <= 500000) { baseFee = 49; } 
                    else if (contractValue <= 1000000) { baseFee = 89; } 
                    else if (contractValue <= 5000000) { baseFee = 119; } 
                    else if (contractValue <= 10000000) { baseFee = 159; } 
                    else { baseFee = contractValue * 0.0002; }
                } 
                else {
                    if (contractValue <= 0) {
                        baseFee = 24;
                        isFinancial = false;
                    } else {
                        isFinancial = true;
                        if (contractValue <= 1000) { baseFee = 25; } 
                        else if (contractValue <= 10000) { const increments = Math.ceil((contractValue - 1000) / 1000); baseFee = 25 + (increments * 2); } 
                        else if (contractValue <= 100000) { const baseAt10k = 43; const increments = Math.ceil((contractValue - 10000) / 5000); baseFee = baseAt10k + (increments * 5); } 
                        else if (contractValue <= 500000) { baseFee = contractValue * 0.0012; } 
                        else if (contractValue <= 1000000) { baseFee = contractValue * 0.0010; } 
                        else if (contractValue <= 10000000) { baseFee = contractValue * 0.0008; } 
                        else { baseFee = contractValue * 0.0006; }
                    }
                }

                const extraPeopleFee = Math.max(0, partyCount - 3) * 2;
                let totalFee = baseFee + extraPeopleFee;

                if (mode === 'text' && totalFee > 100) { totalFee = totalFee * 0.90; }

                return {
                    total: Math.max(0, totalFee).toFixed(2),
                    base: baseFee.toFixed(2),
                    extra: extraPeopleFee.toFixed(2),
                    isFinancial: isFinancial
                };
            }
        };

        // --- FIREBASE HELPER FUNCTIONS ---
        function blobToBase64(blob) {
            return new Promise((resolve, _) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(blob);
            });
        }
        function base64ToBlob(base64, mimeType = 'video/webm') {
            const byteString = atob(base64.split(',')[1]);
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            return new Blob([ab], { type: mimeType });
        }

        async function save(item) { 
            try { 
                const cleanItem = JSON.parse(JSON.stringify(item));
                await db.ref('contracts/' + item.id).set(cleanItem);
                showToast("Synced to Cloud");
            } catch(e) { 
                console.error(e); showToast("Sync Error: " + e.message, "error"); 
            } 
        }

        async function loadAll() { 
            try { 
                const snapshot = await db.ref('contracts').get();
                if (snapshot.exists()) {
                    return Object.values(snapshot.val());
                } else {
                    return [];
                }
            } catch(e) { 
                console.error(e); return []; 
            } 
        }

        async function saveVideoToDB(key, blob) { 
            try {
                const base64 = await blobToBase64(blob);
                await db.ref('videos/' + key).set({ data: base64 });
            } catch(e) { console.error("Video Save Error:", e); }
        }

        async function loadVideoFromDB(key) { 
            try {
                const snapshot = await db.ref('videos/' + key).get();
                if (snapshot.exists()) {
                    const base64 = snapshot.val().data;
                    return base64ToBlob(base64);
                }
                return null;
            } catch(e) { return null; }
        }

        // --- EXPORT FUNCTIONS TO WINDOW ---
        window.setAuthMode = function(mode) {
            const token = document.getElementById('manual-token').value.trim();
            if(token && contract) return;
            selectedAuthMode = mode;
            const btnVideo = document.getElementById('mode-btn-video');
            const btnText = document.getElementById('mode-btn-text');
            const lblChk1 = document.getElementById('lbl-chk-1');
            const desc = document.getElementById('mode-desc');

            if (mode === 'video') {
                btnVideo.classList.add('bg-[#d4af37]', 'text-black'); btnVideo.classList.remove('text-gray-500', 'hover:text-white');
                btnText.classList.remove('bg-[#d4af37]', 'text-black'); btnText.classList.add('text-gray-500', 'hover:text-white');
                lblChk1.innerHTML = '<strong class="text-white">1. Forensic Data Consent:</strong> I explicitly authorize the recording of my Biometrics (Video/Audio), Geolocation (GPS), and Device Fingerprint (IP) to generate an evidentiary packagefor the registration and issuance of my intended instrument .';
                desc.innerText = "Highest security. Requires Camera & Microphone.";
            } else {
                btnText.classList.add('bg-[#d4af37]', 'text-black'); btnText.classList.remove('text-gray-500', 'hover:text-white');
                btnVideo.classList.remove('bg-[#d4af37]', 'text-black'); btnVideo.classList.add('text-gray-500', 'hover:text-white');
                lblChk1.innerHTML = '<strong class="text-white">1. Digital Log Consent:</strong> I explicitly authorize the secure logging and retention of my Digital Signature, IP address, GPS location, and precise Timestamp (excluding any video recording) for the registration and issuance of my intended instrument.';
                desc.innerText = "Standard security. No Camera required.";
            }
        };

      // --- UPDATED: LOAD TEMPLATE WITH SMART SPANS ---
      window.loadTemplateInputs = function() {
            const key = document.getElementById('template-select').value;
            const container = document.getElementById('smart-inputs');
            const editorDiv = document.getElementById('create-text'); // Changed from textArea
            
            container.innerHTML = '<h4 class="text-xs text-white font-bold border-b border-gray-700 pb-2 mb-3">Fill Details</h4>';
            
            inputHistory = {};

            if (!key || key === 'custom') { 
                container.classList.add('hidden'); 
                if(!key) editorDiv.innerText = ''; 
                return; 
            }
            
            container.classList.remove('hidden'); 
            
            // Generate inputs
            TEMPLATES[key].fields.forEach(field => {
                const div = document.createElement('div'); div.className = 'template-form-group';
                div.innerHTML = `<label class="template-label">${field}</label><input type="text" class="w-full input-field p-2 text-xs rounded" oninput="updateTemplateText('${key}', '${field}', this)" data-field="${field}">`;
                container.appendChild(div);
            });

            // Initial generation with SMART SPANS
            let data = {};
            TEMPLATES[key].fields.forEach(f => { 
                // Create a unique ID for the span based on the field name
                const safeField = f.replace(/[^a-zA-Z0-9]/g, '_');
                const spanId = `var_${safeField}`;
                // Inject the span HTML instead of plain text
                data[f] = `<span id="${spanId}" class="smart-var" data-field="${f}">[${f}]</span>`; 
            });
            
            // Set innerHTML because we are injecting HTML tags (spans)
            editorDiv.innerHTML = TEMPLATES[key].text(data);
        };

        // --- UPDATED: SMART UPDATE LOGIC (TARGETS SPANS) ---
        window.updateTemplateText = function(key, changedField, inputElement) {
            const newValue = inputElement.value || `[${changedField}]`;
            
            // Find the specific span for this field inside the editor
            // We use the data-field attribute to find the correct span
            const span = document.querySelector(`#create-text span[data-field="${changedField}"]`);
            
            if (span) {
                // Update only the text inside the span
                span.innerText = newValue;
            } else {
                // If span is missing (user deleted it), we might want to re-generate or just ignore.
                // For safety and to avoid "cancerous" behavior, we ignore if the user deleted the anchor.
                console.log("Smart anchor missing for:", changedField);
            }
        };

        function showToast(message, type='success', duration=4000){
            const toast = document.getElementById('toast-msg'); const text = document.getElementById('toast-text'); if(!toast) return;
            toast.style.display='flex'; toast.style.borderColor = type==='error'? '#f87171' : '#d4af37'; toast.style.background = type==='error'? 'rgba(127,29,29,0.9)' : 'rgba(13,18,35,0.95)'; toast.style.color = '#d4af37'; text.innerText = message; setTimeout(()=>{ toast.style.display='none'; }, duration);
        }
        
        window.copyToClipboard = function(text, msg='Copied'){ if(!text) return; navigator.clipboard?.writeText(text).then(()=>showToast(msg,'success',2000)).catch(()=>alert(msg)); }
        
        function generateDocNumber(existingNums=[]){ const used = new Set(existingNums); let num=''; do{ num = Math.floor(10000000 + Math.random() * 90000000).toString(); } while(used.has(num)); return num; }
        
        window.exportBackup = async function(){ const data = await loadAll(); const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'essproof-backup.lgl'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showToast('Backup exported'); }
        
        // --- IMPORT FUNCTION ---
        window.importBackup = function(input) {
            if(!confirm("IMPORT BACKUP:\nThis feature allows you to restore your document history from a previously exported .LGL file.\n\nDo you want to proceed?")) {
                input.value = '';
                return;
            }

            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!Array.isArray(data)) throw new Error("Invalid backup format");
                    for (const doc of data) {
                        await db.ref('contracts/' + doc.id).set(doc);
                    }
                    showToast("Backup Imported Successfully");
                    renderRepo(); 
                } catch (err) {
                    console.error(err);
                    alert("Import Failed: " + err.message);
                }
            };
            reader.readAsText(file);
            input.value = ''; 
        };

        async function computeHash(text){ try{ const enc = new TextEncoder().encode(text); const buf = await crypto.subtle.digest('SHA-256', enc); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('').toUpperCase(); }catch(e){ return "0x" + Math.random().toString(16).substr(2, 64).toUpperCase(); } }
        
        // --- REAL FORENSIC DATA CAPTURE ---
        async function captureForensics() {
            // 1. Get Real IP
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                userRealIP = data.ip;
            } catch (e) {
                console.error("IP Fetch Error", e);
                userRealIP = "IP_DETECT_FAIL";
            }

            // 2. Get Real GPS
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userRealGPS = `${position.coords.latitude.toFixed(6)} N, ${position.coords.longitude.toFixed(6)} E`;
                    },
                    (error) => {
                        console.error("GPS Error", error);
                        userRealGPS = "GPS_DENIED_BY_USER";
                    }
                );
            } else {
                userRealGPS = "GPS_NOT_SUPPORTED";
            }
        }

        window.initSignaturePad = function() {
            canvas = document.getElementById('sig-canvas'); if(!canvas) return;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width; canvas.height = rect.height;
            const newCanvas = canvas.cloneNode(true);
            canvas.parentNode.replaceChild(newCanvas, canvas);
            canvas = newCanvas;
            ctx = canvas.getContext('2d'); ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = "#000000"; ctx.lineWidth = 2; ctx.lineCap = 'round';
            canvas.addEventListener('mousedown', startDraw); canvas.addEventListener('mousemove', draw); canvas.addEventListener('mouseup', stopDraw); canvas.addEventListener('mouseout', stopDraw);
            canvas.addEventListener('touchstart', (e)=>{ e.preventDefault(); startDraw(e.touches[0]); }, {passive:false});
            canvas.addEventListener('touchmove', (e)=>{ e.preventDefault(); draw(e.touches[0]); }, {passive:false});
            canvas.addEventListener('touchend', (e)=>{ e.preventDefault(); stopDraw(); }, {passive:false});
        };
        function startDraw(e) { isDrawing = true; ctx.beginPath(); const rect = canvas.getBoundingClientRect(); ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top); }
        function draw(e) { if (!isDrawing) return; const rect = canvas.getBoundingClientRect(); ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top); ctx.stroke(); }
        function stopDraw() { isDrawing = false; }
        window.clearSignature = function() { if(ctx) { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, canvas.width, canvas.height); } };

        window.onload = async function() { 
            document.getElementById('manual-token').value = ''; 
            ['auth-name','auth-nid', 'auth-pin'].forEach(id=>{ const el = document.getElementById(id); if(el) el.addEventListener('input', validateConsent); });
            const filter = document.getElementById('repo-filter'); if(filter) filter.addEventListener('input', ()=>renderRepo());
        };

        window.validateConsent = function() {
            const c1 = document.getElementById('chk-1').checked; const c2 = document.getElementById('chk-2').checked; const c3 = document.getElementById('chk-3').checked;
            const nameVal = document.getElementById('auth-name').value.trim(); const nidVal = document.getElementById('auth-nid').value.trim();
            const pinVal = document.getElementById('auth-pin').value.trim();
            const btn = document.getElementById('btn-auth');
            
            if (c1 && c2 && c3 && nameVal && nidVal && pinVal) { 
                btn.disabled = false; btn.classList.remove('opacity-50', 'cursor-not-allowed', 'grayscale'); 
            } else { 
                btn.disabled = true; btn.classList.add('opacity-50', 'cursor-not-allowed', 'grayscale'); 
            }
        };

        window.requestCustody = function() { 
            const chk = document.getElementById('chk-custody'); 
            if(!chk.checked) return alert("Please check the custody request box."); 
            if(!selectedDocId) return alert("Please SELECT a document row first.");
            showToast('REQUEST REGISTERED. PHYSICAL ARCHIVE INITIATED.'); 
            setTimeout(()=>{ chk.checked=false; }, 1500); 
        };

        window.openJudiciaryLogin = function() { document.getElementById('modal-judiciary-auth').classList.remove('hidden'); };
        window.authenticateJudge = async function() {
            const token = document.getElementById('judge-token').value.trim(); const target = document.getElementById('judge-target').value.trim();
            if(!["JUDGE-KEY-2025","1234567"].includes(token)) return alert("ACCESS DENIED.");
            const allDocs = await loadAll(); const doc = allDocs.find(d => d.docNumber===target || d.id===target);
            if(!doc) return alert("No record found.");
            
            activeJudgeDoc = doc; 
            document.getElementById('modal-judiciary-auth').classList.add('hidden'); document.getElementById('modal-judiciary-view').classList.remove('hidden');
            document.getElementById('judge-doc-number').innerText = doc.docNumber; document.getElementById('judge-doc-hash').innerText = doc.hash || "PENDING"; document.getElementById('judge-time').innerText = doc.created;
            
            const sigContainer = document.getElementById('judge-sigs'); sigContainer.innerHTML = '';
            doc.parties.forEach(p => {
                const vidKey = `${doc.id}-${p.nid}`;
                const vidBtn = (p.signed && doc.requiresVideo !== false) ? `<button onclick="openVideoModal('${vidKey}')" class="text-[9px] bg-blue-600 hover:bg-blue-500 text-white border border-blue-400 px-3 py-1 rounded transition flex items-center gap-1 shadow-md"><i class="fas fa-play-circle"></i> Evidence</button>` : `<span class="text-[9px] text-gray-500 italic border border-gray-700 px-2 py-1 rounded">No Video</span>`;
                const meta = p.evidence || {ip:'N/A', gps:'N/A'};
                sigContainer.innerHTML += `<div class="border border-white/10 rounded p-3 mb-2 text-xs bg-black/40"><div class="flex justify-between items-center mb-2"><span class="text-white font-bold flex items-center gap-2"><i class="fas fa-user-check text-[#d4af37]"></i> ${p.name}</span><span class="${p.signed?'text-green-400':'text-yellow-500'} font-mono text-[9px] border ${p.signed?'border-green-500/30':'border-yellow-500/30'} px-1 rounded">${p.signed?'VERIFIED':'WAITING'}</span></div><div class="flex justify-between items-end"><div class="grid grid-cols-1 gap-1 text-gray-400 font-mono text-[9px]"><div>ID: <span class="text-gray-300">${p.nid}</span></div><div>IP: <span class="text-blue-300">${meta.ip}</span></div><div>GPS: <span class="text-blue-300">${meta.gps}</span></div></div><div>${vidBtn}</div></div></div>`;
            });
            renderJudgeMode(doc.status === 'EXECUTED');
        };

        function escapeHtml(text) { if (!text) return ''; return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
        function generatePaperHTML(doc) {
            const sigsHTML = doc.parties.map(p => `
                <div class="paper-sig-block">
                    ${p.signatureImg ? `<img src="${p.signatureImg}" style="height:40px;display:block;margin-bottom:5px;">` : '<strong>[PENDING]</strong><br>'}
                    <strong>${p.name}</strong><br>ID: ${p.nid}<br>
                    ${p.signed ? `<span class="meta-data">Date: ${p.date}<br>IP: ${p.evidence?.ip}<br>GPS: ${p.evidence?.gps}</span>` : ''}
                </div>`).join('');
            const safeText = escapeHtml(doc.text);
            return `<div class="paper-view"><div class="paper-watermark">EssProof</div><div class="paper-header"><h1>EssProof</h1><p style="font-size:10px;text-transform:uppercase;color:#555;">PRIVATE NON-GOVERNMENTAL PLATFORM<br>Secure Digital Instrument Registry</p></div><div class="paper-title">${doc.type}</div><div style="font-size: 10px; margin-bottom: 20px; font-family:monospace;">Ref: ${doc.docNumber} | Mode: ${doc.requiresVideo !== false ? 'Video Shield' : 'Standard Text'}</div><div class="paper-body">${safeText}</div><div class="paper-sigs">${sigsHTML}</div><div class="paper-hash-box"><strong>FINAL CRYPTOGRAPHIC SEAL (SHA-256):</strong><br>${doc.hash || 'NOT FINALIZED'}</div></div>`;
        }

        window.renderJudgeMode = function(isEncryptedMode) {
            const container = document.getElementById('judge-doc-container');
            const controls = document.getElementById('judge-controls');
            container.innerHTML = ''; controls.innerHTML = '';
            if (isEncryptedMode && activeJudgeDoc.status === 'EXECUTED') {
                 const encryptedText = btoa(unescape(encodeURIComponent(activeJudgeDoc.text)));
                 controls.innerHTML = `<button onclick="renderJudgeMode(false)" class="w-full bg-red-600 text-white py-4 rounded font-bold shadow-lg hover:bg-red-700 transition uppercase tracking-widest text-xs mb-4"><i class="fas fa-unlock mr-2"></i> DECRYPT & VERIFY CONTENT</button>`;
                 container.innerHTML = `<div class="encrypted-view">${encryptedText}</div>`;
            } else {
                 if(activeJudgeDoc.status === 'EXECUTED') {
                    controls.innerHTML = `<button onclick="renderJudgeMode(true)" class="w-full bg-green-600 text-white py-4 rounded font-bold shadow-lg hover:bg-green-700 transition uppercase tracking-widest text-xs mb-4"><i class="fas fa-lock mr-2"></i> RE-ENCRYPT VIEW</button>`;
                 }
                 container.innerHTML = generatePaperHTML(activeJudgeDoc);
            }
        };
        window.closeJudiciaryView = function() { document.getElementById('modal-judiciary-view').classList.add('hidden'); document.getElementById('judge-token').value = ''; document.getElementById('judge-target').value = ''; activeJudgeDoc = null; };

        window.startNewFlow = function() { 
            document.getElementById('manual-token').value = ''; 
            resetAuthForm(); 
            const ctr = document.getElementById('mode-selector-container');
            ctr.style.pointerEvents = 'auto'; ctr.style.opacity = '1';
            document.getElementById('mode-desc').innerText = "Highest security. Requires Camera & Microphone.";
            document.getElementById('sec-hub').classList.add('hidden'); 
            document.getElementById('sec-auth').classList.remove('hidden'); 
            document.getElementById('auth-warning').classList.add('hidden'); 
        };
        
        function resetAuthForm() { 
            document.getElementById('auth-name').value = ''; document.getElementById('auth-nid').value = ''; 
            document.getElementById('auth-pin').value = ''; 
            document.getElementById('chk-1').checked = false; document.getElementById('chk-2').checked = false; document.getElementById('chk-3').checked = false; 
            setAuthMode('video');
            const btn = document.getElementById('btn-auth'); btn.disabled = true; btn.classList.add('opacity-50', 'cursor-not-allowed', 'grayscale'); 
        }

        window.processToken = async function() { 
            let t = document.getElementById('manual-token').value.trim(); if(!t) return alert("Enter Key"); 
            try { 
                const all = await loadAll();
                const found = all.find(c => c.roomKey === t);
                if (found) {
                    contract = found;
                } else {
                    throw new Error("Room Key not found in local record.");
                }
                
                const tempContract = contract;
                contract = null;
                const requiredMode = (tempContract.requiresVideo !== false) ? 'video' : 'text';
                setAuthMode(requiredMode);
                contract = tempContract;

                const modeContainer = document.getElementById('mode-selector-container');
                modeContainer.style.pointerEvents = 'none'; 
                modeContainer.style.opacity = '0.7'; 
                const typeLabel = requiredMode === 'video' ? 'VIDEO SHIELD' : 'STANDARD TEXT';
                document.getElementById('mode-desc').innerHTML = `<span class="text-[#d4af37]"><i class="fas fa-lock"></i> MANDATORY:</span> Contract requires <strong>${typeLabel}</strong>.`;
                
                document.getElementById('auth-name').value = ''; document.getElementById('auth-nid').value = '';
                document.getElementById('auth-pin').value = ''; 
                document.getElementById('chk-1').checked = false; document.getElementById('chk-2').checked = false; document.getElementById('chk-3').checked = false; 
                
                document.getElementById('sec-hub').classList.add('hidden'); 
                document.getElementById('sec-auth').classList.remove('hidden'); 
                document.getElementById('auth-warning').classList.remove('hidden'); 
                document.getElementById('target-doc-name').innerText = contract.type; 
            } catch(e) { alert("Invalid Access Key or Token"); console.error(e); } 
        };

        window.openDashboard = function(){ 
            if(!user.name || !user.nid) { const loginModal = document.getElementById('modal-repo-login'); loginModal.classList.remove('hidden'); loginModal.classList.add('flex'); } else { document.getElementById('modal-dashboard').classList.remove('hidden'); renderRepo(); }
        };
        
        window.performLogin = async function() {
            const name = document.getElementById('login-name').value.trim();
            const nid = document.getElementById('login-nid').value.trim();
            const pin = document.getElementById('login-pin').value.trim();

            if(!name || !nid || !pin) return alert("Please fill in all fields.");

            try {
                const snapshot = await db.ref('users/' + nid).get();
                
                if (!snapshot.exists()) {
                    return alert("User not found. Please create a document to register first.");
                }

                const userData = snapshot.val();
                
                if (userData.pin === pin) {
                    user.name = userData.name; 
                    user.nid = nid;
                    user.pin = pin; 

                    document.getElementById('modal-repo-login').classList.add('hidden'); 
                    document.getElementById('modal-repo-login').classList.remove('flex');
                    document.getElementById('modal-dashboard').classList.remove('hidden'); 
                    renderRepo(); 
                    showToast(`Welcome back, ${user.name}`);
                } else {
                    alert("Invalid Security PIN or Credentials.");
                }
            } catch (e) {
                console.error(e);
                alert("Login Error: " + e.message);
            }
        };

        window.closeDashboard = function(){ document.getElementById('modal-dashboard').classList.add('hidden'); selectedDocId = null; };

        window.selectRepoRow = function(id) {
            selectedDocId = id;
            document.querySelectorAll('.repo-row').forEach(row => { row.classList.remove('selected-row'); });
            const selectedRow = document.getElementById(`row-${id}`);
            if(selectedRow) selectedRow.classList.add('selected-row');
        };

        window.renderRepo = async function(){
            const tbody = document.getElementById('repo-body'); 
            tbody.innerHTML='<tr><td colspan="6" class="text-center py-4"><i class="fas fa-circle-notch fa-spin text-[#d4af37]"></i> Syncing with Cloud...</td></tr>'; 
            
            let rows = await loadAll();

            // ***  :    (  ) ***
            //             
            rows.sort((a, b) => new Date(b.created) - new Date(a.created));

            tbody.innerHTML=''; 

            if(user.nid) { rows = rows.filter(doc => { return doc.parties.some(p => p.nid === user.nid); }); }
            
            const filterTerm = (document.getElementById('repo-filter')?.value || '').toLowerCase();
            
            // :  reverse      sort  
            rows = rows.filter(c => { 
                if(!filterTerm) return true; 
                const typeStr = (c.type || '').toLowerCase();
                const codeStr = (c.docNumber || '').toString().toLowerCase();
                const nameStr = c.parties.map(p => (p.name || '').toLowerCase()).join(' ');
                const idStr = c.parties.map(p => (p.nid || '').toString().toLowerCase()).join(' ');
                return typeStr.includes(filterTerm) || codeStr.includes(filterTerm) || nameStr.includes(filterTerm) || idStr.includes(filterTerm);
            });
            
            if(user.name) document.getElementById('dash-user').innerText = user.name;

            if(!rows.length) { 
                tbody.innerHTML='<tr><td colspan="6" class="text-center py-8 text-xs text-gray-500 italic">No documents found matching your criteria.</td></tr>'; 
                return; 
            }
            
            rows.forEach((c)=>{
                const done = c.status==='EXECUTED';
                const badge = done ? '<span class="text-green-500 border border-green-500/30 px-2 py-1 rounded text-[10px] font-bold">EXECUTED</span>' : '<span class="text-yellow-500 border border-yellow-500/30 px-2 py-1 rounded text-[10px] font-bold">PENDING</span>';
                const signedCount = c.parties.filter(p=>p.signed).length; const total = c.parties.length;
                const isVideoDoc = c.requiresVideo !== false; 
                const typeIcon = isVideoDoc ? '<i class="fas fa-video text-blue-400 mr-2" title="Video Secured"></i>' : '<i class="fas fa-file-alt text-gray-400 mr-2" title="Standard Text"></i>';
                
                const roomBtnClass = done ? "bg-gray-800 text-gray-500 cursor-not-allowed opacity-50" : "bg-[#d4af37]/20 text-[#d4af37] hover:bg-[#d4af37] hover:text-black";
                const roomBtnText = done ? "Sealed" : "Room";
                const roomBtnAttr = done ? "disabled" : `onclick="openSigningRoomFromRepo('${c.id}')"`;
                
                tbody.innerHTML += `<tr id="row-${c.id}" onclick="selectRepoRow('${c.id}')" class="repo-row border-b border-gray-800 cursor-pointer hover:bg-white/5 transition"><td class="py-3 pl-4">${badge}</td><td class="py-3 text-[#d4af37] font-mono">${c.docNumber||'--'}</td><td class="py-3 text-white font-bold flex items-center">${typeIcon} ${c.type}</td><td class="py-3 text-xs text-gray-400">${signedCount}/${total} Signed</td><td class="py-3 text-xs font-mono text-gray-500">${new Date(c.created).toLocaleDateString()}</td><td class="py-3 pr-4 text-right"><button onclick="openRepoDetail('${c.id}')" class="text-[10px] border border-white/20 hover:bg-white/10 px-3 py-1 rounded text-white transition mr-2">View Detail</button><button ${roomBtnAttr} class="text-[10px] px-3 py-1 rounded transition ${roomBtnClass}">${roomBtnText}</button></td></tr>`;
            });
        };
        
        window.openSigningRoomFromRepo = async function(id) {
            const all = await loadAll(); contract = all.find(c=>c.id===id);
            if(!contract) return;
            document.getElementById('modal-dashboard').classList.add('hidden');
            renderSigningRoom();
        };

        window.openRepoDetail = async function(id){
            const modal = document.getElementById('modal-repo-detail'); const body = document.getElementById('repo-detail-body');
            body.innerHTML = '<div class="text-center text-[#d4af37] py-10"><i class="fas fa-circle-notch fa-spin text-3xl"></i></div>';
            modal.classList.remove('hidden'); modal.classList.add('flex');
            let rows = await loadAll(); const doc = rows.find(r=>r.id===id);
            if(!doc) { modal.classList.add('hidden'); return; }
            activeDetailDoc = doc;

            let leftSideHtml = ''; 
            doc.parties.forEach(p=>{
                const meta = p.evidence || {ip:'Pending', gps:'Pending'}; const vidKey = `${doc.id}-${p.nid}`;
                const vidBtn = (p.signed && doc.requiresVideo !== false) ? `<button onclick="openVideoModal('${vidKey}')" class="text-[9px] bg-blue-600 hover:bg-blue-500 text-white border border-blue-400 px-3 py-1 rounded transition flex items-center gap-1 shadow-md"><i class="fas fa-play-circle"></i> View Affidavit</button>` : `<span class="text-[9px] text-gray-500 italic border border-gray-700 px-2 py-1 rounded">No Video</span>`;
                leftSideHtml += `<div class="border border-white/10 rounded p-3 mb-2 text-xs bg-black/40"><div class="flex justify-between items-center mb-2"><span class="text-white font-bold flex items-center gap-2"><i class="fas fa-user-check text-[#d4af37]"></i> ${p.name}</span><span class="${p.signed?'text-green-400':'text-yellow-500'} font-mono text-[9px] border ${p.signed?'border-green-500/30':'border-yellow-500/30'} px-1 rounded">${p.signed?'VERIFIED':'WAITING'}</span></div><div class="flex justify-between items-end"><div class="grid grid-cols-1 gap-1 text-gray-400 font-mono text-[9px]"><div>ID: <span class="text-gray-300">${p.nid}</span></div><div>IP: <span class="text-blue-300">${meta.ip}</span></div><div>GPS: <span class="text-blue-300">${meta.gps}</span></div></div><div>${vidBtn}</div></div></div>`;
            });

            let displayContent = ''; let toggleBtn = '';
            if(doc.status === 'EXECUTED') {
                 const enc = btoa(unescape(encodeURIComponent(doc.text)));
                 displayContent = `<div id="repo-view-plain-${doc.id}" class="hidden">${generatePaperHTML(doc)}</div><div id="repo-view-enc-${doc.id}" class="encrypted-view">${enc}</div>`;
                 toggleBtn = `<button onclick="toggleRepoView('${doc.id}')" id="btn-toggle-${doc.id}" class="mb-4 w-full border border-red-500 text-red-500 hover:bg-red-500 hover:text-white px-3 py-3 rounded text-xs uppercase font-bold tracking-widest transition"><i class="fas fa-unlock"></i> Decrypt & Validate</button>`;
            } else {
                 displayContent = generatePaperHTML(doc);
            }

            body.innerHTML = `<div class="flex justify-between items-start gap-4 mb-4 border-b border-white/10 pb-4"><div><div class="text-[10px] text-[#d4af37] uppercase tracking-widest">EssProof Record</div><div class="text-2xl text-white font-bold">${doc.type}</div><div class="flex items-center gap-3 mt-1"><span class="text-lg text-[#d4af37] font-mono font-bold">CODE: ${doc.docNumber}</span></div></div><div><button onclick="printDocument('${doc.id}')" class="relative right-12 text-[10px] bg-white text-black px-3 py-1 rounded font-bold hover:bg-gray-200 transition"><i class="fas fa-print mr-1"></i> Print/PDF</button></div></div><div class="grid grid-cols-1 md:grid-cols-12 gap-6 h-full"><div class="md:col-span-4 overflow-y-auto max-h-[500px] pr-2"><div class="text-[10px] text-[#d4af37] uppercase tracking-widest mb-3 border-b border-white/10 pb-1">Biometric Evidence Chain</div>${leftSideHtml}</div><div class="md:col-span-8 h-full overflow-y-auto pb-10" id="repo-content-area-${doc.id}"><div class="text-[10px] text-[#d4af37] uppercase tracking-widest mb-2">Original Instrument Content</div>${toggleBtn} ${displayContent}</div></div>`;
        };
        window.closeRepoDetail = function(){ document.getElementById('modal-repo-detail').classList.add('hidden'); document.getElementById('modal-repo-detail').classList.remove('flex'); activeDetailDoc = null; };
        
        window.toggleRepoView = function(id) { 
            const plain = document.getElementById(`repo-view-plain-${id}`); const enc = document.getElementById(`repo-view-enc-${id}`); const btn = document.getElementById(`btn-toggle-${id}`);
            if(plain.classList.contains('hidden')) {
                plain.classList.remove('hidden'); enc.classList.add('hidden');
                btn.innerHTML = '<i class="fas fa-lock"></i> Re-Encrypt'; btn.className = "mb-4 w-full bg-green-600 text-white px-3 py-3 rounded text-xs uppercase font-bold tracking-widest transition hover:bg-green-700";
            } else {
                plain.classList.add('hidden'); enc.classList.remove('hidden');
                btn.innerHTML = '<i class="fas fa-unlock"></i> Decrypt & Validate'; btn.className = "mb-4 w-full border border-red-500 text-red-500 hover:bg-red-500 hover:text-white px-3 py-3 rounded text-xs uppercase font-bold tracking-widest transition";
            } 
        };

        window.submitAuth = function() {
            const n = document.getElementById('auth-name').value; const i = document.getElementById('auth-nid').value; 
            const pin = document.getElementById('auth-pin').value;
            
            if(!n || !i || !pin) return alert("All fields are required, including PIN.");
            if (!/^\d{6}$/.test(pin)) return alert("Security PIN must be exactly 6 digits.");

            const btn = document.getElementById('btn-auth'); btn.innerText = "Scanning..."; document.getElementById('bio-scan-line').style.display = 'block';
            
            // --- TRIGGER REAL FORENSIC CAPTURE ---
            captureForensics();

            setTimeout(async () => {
                user.name=n; user.nid=i; user.pin=pin;
                
                try {
                    await db.ref('users/' + user.nid).set({ name: user.name, pin: user.pin });
                } catch(e) { console.error("User Save Error", e); }

                if(contract) {
                    const idx = contract.parties.findIndex(p=>p.nid===user.nid); if(idx===-1) { alert("Access Denied: ID not found in roster."); location.reload(); return; }
                    document.getElementById('sec-auth').classList.add('hidden'); 
                    renderSigningRoom();
                } else {
                    document.getElementById('sec-auth').classList.add('hidden'); document.getElementById('sec-create').classList.remove('hidden'); document.getElementById('creator-name-display').innerText=user.name; renderRosterInputs();
                }
            }, 1000);
        };

        window.toggleMode = function() { const m = document.getElementById('contract-mode').value; document.getElementById('roster-section').className = m==='multi' ? 'bg-white/5 p-4 rounded border border-white/10' : 'hidden'; if(m==='multi' && document.getElementById('roster-list').children.length===0) addRow(); };
        window.addRow = function() { const div = document.createElement('div'); div.className = "flex gap-2 items-center mb-2 fade-in"; div.innerHTML = `<input type="text" placeholder="Name" class="p-name w-1/2 input-field p-2 text-xs rounded"><input type="text" placeholder="ID" class="p-nid w-1/2 input-field p-2 text-xs rounded"><button onclick="this.parentElement.remove()" class="text-red-500"><i class="fas fa-times"></i></button>`; document.getElementById('roster-list').appendChild(div); };
        window.renderRosterInputs = function() { document.getElementById('roster-list').innerHTML = `<div class="flex gap-2 items-center mb-2 opacity-50"><input value="${user.name}" readonly class="w-1/2 input-field p-2 text-xs rounded border-[#d4af37]"><input value="${user.nid}" readonly class="w-1/2 input-field p-2 text-xs rounded"><span class="text-[9px] text-[#d4af37] uppercase font-bold px-2">Initiator</span></div>`; };

        window.smartGoToSigning = async function() {
            // UPDATED: Get text from innerText (Source of Truth)
            const rawText = document.getElementById('create-text').innerText; 
            const text = rawText || "Standard Agreement"; 
            const mode = document.getElementById('contract-mode').value;
            const tmplKey = document.getElementById('template-select').value;
            
            if(tmplKey && tmplKey!=='custom' && !rawText.trim()){ 
                 alert("Document text is empty."); return; 
            }

            let parties = [{name:user.name, nid:user.nid, signed:false, role:'Initiator'}];
            if(mode==='multi') { const rows = document.querySelectorAll('#roster-list .flex'); for(let i=1; i<rows.length; i++) { const n = rows[i].querySelector('.p-name')?.value; const id = rows[i].querySelector('.p-nid')?.value; if(!n || !id){ alert("Fill signatory details"); return; } parties.push({name:n, nid:id, signed:false, role:'Signatory'}); } }
            
            const existing = await loadAll(); 
            const docNumber = generateDocNumber(existing.map(r=>r.docNumber).filter(Boolean)); 
            const newId = 'LC-'+Math.floor(Math.random()*1000000);
            const roomKey = Math.floor(100000000000000 + Math.random() * 900000000000000).toString();
            const requiresVideo = (selectedAuthMode === 'video');

            pendingContractData = { 
                id: newId, 
                docNumber: docNumber, 
                roomKey: roomKey, 
                type: document.getElementById('template-select').value || 'Custom Instrument', 
                text: text, 
                parties: parties, 
                status: 'PENDING', 
                hash: '', 
                requiresVideo: requiresVideo, 
                created: new Date().toISOString() 
            };
            calculateAndShowPayment();
        };

        function parseMoney(inputStr) {
            if (!inputStr) return 0;
            const persianDigits = [//g, //g, //g, //g, //g, //g, //g, //g, //g, //g];
            for (let i = 0; i < 10; i++) { inputStr = inputStr.replace(persianDigits[i], i); }
            let cleanStr = inputStr.replace(/[^0-9.]/g, '');
            let val = parseFloat(cleanStr);
            return isNaN(val) ? 0 : val;
        }

        window.calculateAndShowPayment = function() {
            let totalValue = 0;
            const inputs = Array.from(document.querySelectorAll('#smart-inputs input'));
            const contractMode = document.getElementById('contract-mode').value; 
            const docType = document.getElementById('template-select').value; 

            // --- VALUE EXTRACTION LOGIC ---

            // 1. Last Will
            if (docType === 'will') {
                const estateVal = inputs.find(i => i.dataset.field === 'Total Estate Value');
                if (estateVal) totalValue = parseMoney(estateVal.value);
            }
            // 2. Single Party (Non-Financial)
            else if (contractMode === 'single') {
                totalValue = 0; 
            }
            // 3. Multi-Party
            else {
                const getValueByField = (keywords) => {
                     const match = inputs.find(i => {
                         const fieldName = (i.dataset.field || '').toLowerCase();
                         return keywords.some(k => fieldName.includes(k.toLowerCase()));
                     });
                     if(!match) return 0;
                     return parseMoney(match.value);
                };

                // A) Rent / Lease Logic (Rate * Duration)
                const monthlyRent = getValueByField(['Monthly Rent', 'Rent Amount', 'Rental Rate']);
                if (monthlyRent > 0) {
                    let duration = getValueByField(['Duration', 'Term', 'Length']);
                    if (duration === 0) duration = 12; // Default to 12 if not found/zero
                    totalValue = monthlyRent * duration;
                } 
                // B) Other Financial Docs
                else {
                    const moneyKeywords = [
                        'Amount', 'Price', 'Fee', 'Loan', 'Cost', 'Value', 
                        'Sale Price', 'Purchase Price', 'Compensation', 'Salary', 
                        'Settlement', 'Total', 'Investment', 'Capital', 'Consideration',
                        'Debt', 'Payment'
                    ];
                    
                    let maxVal = 0;
                    inputs.forEach(input => {
                        const fieldName = (input.dataset.field || '').toLowerCase();
                        if (moneyKeywords.some(k => fieldName.includes(k.toLowerCase()))) {
                            const val = parseMoney(input.value);
                            if (val > maxVal) maxVal = val;
                        }
                    });
                    totalValue = maxVal;
                }
            }

            // --- ANTI-FRAUD: SCAN TEXT FOR HIGHER VALUES (UPDATED: SCANS INNER TEXT) ---
            // Now scans the actual document text (Source of Truth)
            const textContent = document.getElementById('create-text').innerText;
            
            const regex = /[\$\\]\s*([\d,]+(\.\d{2})?)|([\d,]+(\.\d{2})?)\s*(USD|Dollars|EUR|Euro)/gi;
            let match;
            let maxTextValue = 0;
            
            while ((match = regex.exec(textContent)) !== null) {
                const numStr = match[1] || match[3];
                if(numStr) {
                    const val = parseMoney(numStr);
                    if(val > maxTextValue) maxTextValue = val;
                }
            }

            if(maxTextValue > totalValue) {
                totalValue = maxTextValue;
                console.log("Anti-Fraud Triggered: Using text value", totalValue);
            }

            const partyCount = pendingContractData.parties.length;
            const result = PricingEngine.calculate(totalValue, partyCount, selectedAuthMode, docType);

            currentPaymentRaw = parseFloat(result.total);

            document.getElementById('pay-total').innerText = `$${result.total}`;
            document.getElementById('pay-base').innerText = `$${result.base}`;
            document.getElementById('pay-extra').innerText = `$${result.extra}`;
            document.getElementById('pay-tier').innerText = result.isFinancial ? "FINANCIAL" : "NON-FINANCIAL";
            document.getElementById('inv-num').innerText = Math.floor(Math.random() * 900000);

            document.getElementById('discount-display-container').classList.add('hidden');
            document.getElementById('pay-original').innerText = '';
            document.getElementById('pay-discount').innerText = '';
            document.getElementById('pay-student-id').value = '';

            document.getElementById('modal-payment').classList.remove('hidden');
            document.getElementById('modal-payment').classList.add('flex');
        };

        window.closePaymentModal = function() {
            document.getElementById('modal-payment').classList.add('hidden');
            document.getElementById('modal-payment').classList.remove('flex');
            // User stays on sec-create to edit
        };

        window.applyStudentDiscount = function() {
            const idVal = document.getElementById('pay-student-id').value.trim();
            if(!idVal) return alert("Please enter a valid Student ID.");
            
            // 20% Discount
            const discountAmount = currentPaymentRaw * 0.20;
            const newTotal = currentPaymentRaw - discountAmount;

            document.getElementById('discount-display-container').classList.remove('hidden');
            document.getElementById('pay-original').innerText = `$${currentPaymentRaw.toFixed(2)}`;
            document.getElementById('pay-discount').innerText = `-$${discountAmount.toFixed(2)}`;
            document.getElementById('pay-total').innerText = `$${newTotal.toFixed(2)}`;
            
            showToast("Student Discount Applied!", "success");
        };

        window.processPayment = function() {
            const btn = document.getElementById('btn-pay-confirm'); btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Processing...'; btn.disabled = true;
            setTimeout(async () => {
                await save(pendingContractData); contract = pendingContractData;
                document.getElementById('modal-payment').classList.add('hidden'); document.getElementById('modal-payment').classList.remove('flex');
                document.getElementById('sec-create').classList.add('hidden');
                renderSigningRoom();
                showToast("Invoice Paid. Cloud Room Created.");
            }, 2000);
        };

        window.toggleMenu = function() {
            const menu = document.getElementById('side-menu');
            if (menu.classList.contains('translate-x-full')) {
                menu.classList.remove('translate-x-full');
            } else {
                menu.classList.add('translate-x-full');
            }
        };

        window.openInfoModal = function(type) {
            toggleMenu(); 
            document.querySelectorAll('.info-modal').forEach(m => m.classList.add('hidden'));
            document.querySelectorAll('.info-modal').forEach(m => m.classList.remove('flex'));
            
            const modal = document.getElementById(`modal-${type}`);
            if(modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        };

        window.closeInfoModal = function(type) {
            const modal = document.getElementById(`modal-${type}`);
            if(modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        };

        window.sendContactForm = async function() {
            const email = document.getElementById('contact-email').value;
            const sub = document.getElementById('contact-subject').value;
            const msg = document.getElementById('contact-msg').value;
            if(!email || !msg) return alert("Please fill in all fields.");
            
            try {
                await db.ref('inquiries').push({
                    email: email,
                    subject: sub,
                    message: msg,
                    date: new Date().toISOString()
                });
                showToast("Message Sent Successfully");
                closeInfoModal('contact');
                document.getElementById('contact-email').value = '';
                document.getElementById('contact-msg').value = '';
            } catch(e) {
                console.error(e);
                alert("Message Sent (Local Mode - Cloud Sync Failed)");
                closeInfoModal('contact');
            }
        };

        window.renderSigningRoom = function() {
            if(!contract) return;
            document.querySelectorAll('section').forEach(e=>e.classList.add('hidden')); 
            document.getElementById('sec-signing-room').classList.remove('hidden');
            
            document.getElementById('room-code').innerText = contract.docNumber;
            document.getElementById('room-doc-type').innerText = contract.type;
            document.getElementById('room-text').innerText = contract.text;

            const rosterContainer = document.getElementById('room-roster'); rosterContainer.innerHTML = '';
            const sigsPreview = document.getElementById('room-sigs-preview'); sigsPreview.innerHTML = '';
            let signedCount = 0;

            contract.parties.forEach((p, idx) => {
                if(p.signed) signedCount++;
                const isMe = p.nid === user.nid;
                const vidKey = `${contract.id}-${p.nid}`;
                const vidClass = p.signed ? 'status-gold' : 'status-gray';
                const sigClass = p.signed ? 'status-gold' : 'status-gray';
                
                const vidAction = (p.signed && contract.requiresVideo !== false) ? `onclick="openVideoModal('${vidKey}')"` : '';
                const videoIconStyle = (contract.requiresVideo === false) ? 'opacity:0.3; cursor:not-allowed;' : '';

                const card = `
                    <div class="participant-card ${isMe ? 'active-user' : ''}">
                        <div>
                            <div class="text-[11px] font-bold text-white flex items-center gap-2"><span class="text-[#d4af37]">${idx+1}.</span> ${p.name} ${isMe ? '<span class="bg-[#d4af37] text-black text-[8px] px-1 rounded font-bold">YOU</span>' : ''}</div>
                            <div class="text-[9px] text-gray-500 font-mono">${p.role}</div>
                        </div>
                        <div class="flex"><div class="icon-box ${vidClass}" style="${videoIconStyle}" ${vidAction} title="Video Affidavit"><i class="fas fa-video"></i></div><div class="icon-box ${sigClass}" title="Signature Status"><i class="fas fa-file-signature"></i></div></div>
                    </div>`;
                rosterContainer.innerHTML += card;
                if(p.signed) {
                    sigsPreview.innerHTML += `<div class="flex flex-col gap-1"><div class="h-10 border-b border-black/50 mb-1 w-24 relative"><img src="${p.signatureImg}" class="h-full object-contain"></div><span class="font-bold uppercase text-[9px]">${p.name}</span></div>`;
                }
            });

            document.getElementById('room-status-text').innerText = `${signedCount} / ${contract.parties.length} Signed`;
            
            const isFinished = signedCount === contract.parties.length;
            const tokenBox = document.getElementById('room-token-box');
            const copyBtn = document.getElementById('btn-copy-token');
            
            if (isFinished) {
                tokenBox.innerText = "--- SESSION CLOSED / SEALED ---"; tokenBox.style.color = "#ef4444"; tokenBox.onclick = null;
                copyBtn.disabled = true; copyBtn.classList.add('opacity-50', 'cursor-not-allowed'); copyBtn.innerText = "Closed";
            } else {
                tokenBox.innerText = contract.roomKey || "Generating..."; tokenBox.style.color = "#d4af37"; tokenBox.onclick = copyToken;
                copyBtn.disabled = false; copyBtn.classList.remove('opacity-50', 'cursor-not-allowed'); copyBtn.innerText = "Copy Key";
            }

            const actionArea = document.getElementById('room-action-area');
            const sealedArea = document.getElementById('room-sealed-area');
            const printBtn = document.getElementById('btn-print-room');

            if (isFinished) {
                sealedArea.classList.remove('hidden'); document.getElementById('room-final-hash').innerText = contract.hash || "SEALED";
                printBtn.classList.remove('hidden'); actionArea.classList.add('hidden');
            } else {
                sealedArea.classList.add('hidden'); printBtn.classList.add('hidden');
                const myRecord = contract.parties.find(p => p.nid === user.nid);
                if(myRecord && !myRecord.signed) {
                    actionArea.classList.remove('hidden'); document.getElementById('room-user-name').innerText = user.name;
                } else {
                    actionArea.classList.add('hidden');
                }
            }
        };

        window.copyToken = function() { const txt = document.getElementById('room-token-box').innerText; if(txt.includes("CLOSED")) return; copyToClipboard(txt, 'Access Key Copied'); };

        window.goToSigningSafe = function() {
            document.querySelectorAll('section').forEach(e=>e.classList.add('hidden')); 
            document.getElementById('sec-sign').classList.remove('hidden'); 
            document.getElementById('sign-name-display').innerText=user.name; 
            document.getElementById('sign-id-display').innerText=user.nid;

            const videoContainer = document.getElementById('video-container');
            const btnSeal = document.getElementById('btn-seal');

            if(contract.requiresVideo !== false) {
                videoContainer.classList.remove('hidden');
                btnSeal.disabled = true; btnSeal.classList.add('opacity-50', 'cursor-not-allowed');
                setTimeout(() => { initCam(); initSignaturePad(); }, 200);
            } else {
                videoContainer.classList.add('hidden');
                btnSeal.disabled = false; btnSeal.classList.remove('opacity-50', 'cursor-not-allowed');
                setTimeout(() => { initSignaturePad(); }, 200);
            }
        };

        async function initCam() {
            try {
                videoBlobCaptured = null; const s = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
                document.getElementById('webcam').srcObject=s; document.getElementById('webcam').classList.remove('hidden'); document.getElementById('cam-placeholder').classList.add('hidden');
                setupRecorder(s);
            } catch(e){ showToast('Camera blocked','error',3000); }
        }

        function setupRecorder(stream){
            mediaRecorder = new MediaRecorder(stream); recChunks = []; mediaRecorder.ondataavailable = e => { if(e.data.size>0) recChunks.push(e.data); };
            mediaRecorder.onstop = ()=> {
                const blob = new Blob(recChunks, {type:'video/webm'}); const player = document.getElementById('webcam'); player.srcObject=null; videoBlobCaptured = blob;
                document.getElementById('btn-seal').disabled=false; document.getElementById('btn-seal').classList.remove('opacity-50','cursor-not-allowed');
                document.getElementById('btn-record').innerText="Evidence Captured"; document.getElementById('btn-record').classList.remove('bg-red-900'); document.getElementById('btn-record').classList.add('bg-green-900'); player.srcObject = stream;
            };
        }

        window.toggleRecord = function() {
            const b = document.getElementById('btn-record'); if(!mediaRecorder) return showToast('Recorder not ready','error',2000);
            if(!isRec) { isRec=true; recChunks=[]; b.innerText="Recording... (10s)"; b.classList.add('bg-red-900','text-white'); setTimeout(()=>{ if(isRec) stopRecord(); }, 10000); mediaRecorder.start(); } else { stopRecord(); }
        };
        function stopRecord(){ if(!isRec) return; isRec=false; if(mediaRecorder && mediaRecorder.state==='recording') mediaRecorder.stop(); }

        window.finalizeSigSimple = async function() {
            const btn = document.getElementById('btn-seal');
            const requiresVideo = contract.requiresVideo !== false;

            if(requiresVideo && !videoBlobCaptured) { alert("Video evidence required."); return; }
            if(!contract) { alert("Contract data missing."); return; }
            
            try {
                btn.disabled = true; btn.innerText = "SYNCING & SEALING...";
                
                const snapshot = await db.ref('contracts/' + contract.id).get();
                if (!snapshot.exists()) throw new Error("Document vanished from cloud.");
                let freshContract = snapshot.val();

                const sigDataUrl = document.getElementById('sig-canvas').toDataURL();
                const method = requiresVideo ? "Biometric Video" : "Standard Digital Signature";
                
                // --- USE REAL FORENSIC DATA ---
                document.getElementById('process-status').classList.remove('hidden'); 
                document.getElementById('meta-disp').innerText = `IP: ${userRealIP} | Auth: ${method}`;
                
                const idx = freshContract.parties.findIndex(p => p.nid === user.nid);
                if(idx!==-1) {
                    freshContract.parties[idx].signed = true; 
                    freshContract.parties[idx].date = new Date().toUTCString();
                    // SAVE REAL DATA TO FIREBASE
                    freshContract.parties[idx].evidence = {ip: userRealIP, gps: userRealGPS}; 
                    freshContract.parties[idx].signatureImg = sigDataUrl;
                } else { throw new Error("ID mismatch during sync."); }

                if(requiresVideo && videoBlobCaptured) {
                    await saveVideoToDB(`${freshContract.id}-${user.nid}`, videoBlobCaptured);
                }
                
                const allSigned = freshContract.parties.every(p => p.signed);
                if(allSigned) { 
                    freshContract.status = 'EXECUTED'; 
                    freshContract.hash = await computeHash(JSON.stringify(freshContract)); 
                }
                
                await db.ref('contracts/' + freshContract.id).set(freshContract);
                
                contract = freshContract;
                
                showToast("Signed & Synced Successfully", "success");
                document.getElementById('sec-sign').classList.add('hidden');
                renderSigningRoom();
                
            } catch (error) { console.error(error); alert("Sync Error: " + error.message); btn.disabled = false; btn.innerText = "Retry Sealing"; }
        };

        window.printDocument = async function(id) {
            const allDocs = await loadAll(); const doc = allDocs.find(d => d.id === id) || contract;
            if(!doc) return;
            const safeText = escapeHtml(doc.text);
            const paperContent = generatePaperHTML({...doc, text: safeText});
            const printContent = `<html><head><title>Print ${doc.docNumber}</title><link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet"><style>body { margin: 0; padding: 0; background: #ccc; } .paper-view { font-family: 'Times New Roman', serif; color: black; background: #fff; padding: 40px; position: relative; margin: 20px auto; width: 210mm; min-height: 297mm; box-sizing: border-box; } .paper-watermark { position: absolute; top: 40%; left: 30%; transform: rotate(-45deg); font-size: 80px; color: rgba(0,0,0,0.05); font-family: 'Cinzel', serif; z-index: 0; } .paper-header { text-align: center; border-bottom: 2px solid #d4af37; padding-bottom: 20px; margin-bottom: 30px; position: relative; z-index: 1; } .paper-header h1 { font-family: 'Cinzel', serif; font-size: 16px; margin: 0; } .paper-title { font-size: 18px; text-transform: uppercase; text-align: center; border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 20px; font-weight: bold; } .paper-body { white-space: pre-wrap; word-wrap: break-word; line-height: 1.6; text-align: justify; font-size: 14px; position: relative; z-index: 1; } .paper-sigs { margin-top: 50px; display: flex; gap: 30px; flex-wrap: wrap; position: relative; z-index: 1; } .paper-sig-block { border-top: 1px solid #000; padding-top: 5px; width: 200px; font-size: 11px; } .paper-hash-box { background-color: #fffbeb; border: 2px solid #d4af37; padding: 10px; margin-top: 40px; text-align: center; font-family: monospace; font-size: 10px; color: #855a16; position: relative; z-index: 1; } @media print { body { background: white; } .paper-view { margin: 0; box-shadow: none; } } </style></head><body>${paperContent}</body></html>`;
            const win = window.open('', '', 'height=800,width=900'); win.document.write(printContent); win.document.close(); 
            setTimeout(() => { win.print(); }, 500);
        };

        window.openVideoModal = async function(vidKey){ const blob = await loadVideoFromDB(vidKey); if(!blob) return showToast('No Cloud video found.','error',3000); const url = URL.createObjectURL(blob); const modal = document.getElementById('modal-video'); const player = document.getElementById('evidence-player'); player.src = url; modal.classList.remove('hidden'); modal.classList.add('flex'); };
        window.closeVideoModal = function(){ const modal = document.getElementById('modal-video'); const player = document.getElementById('evidence-player'); player.pause(); player.src=""; modal.classList.add('hidden'); modal.classList.remove('flex'); };

    </script>
    </body>
    </html>